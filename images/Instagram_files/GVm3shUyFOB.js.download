;/*FB_PKG_DELIM*/

__d("LSAppendDataTraceAddon.nop",["LSAppendDataTraceAddonStoredProcedure","LSFactory","MetaConfig","Promise"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(o,a,i,l,s,u,c){return r("MetaConfig")._("62")?r("LSAppendDataTraceAddonStoredProcedure")(r("LSFactory")(o),{checkPointId:l,dataTraceId:i,errorMessage:u!=null?u:"",syncChannel:s,tags:c!=null?c:""}):(e||(e=n("Promise"))).resolve()};s.__nop_name__="LSAppendDataTraceAddonNop",l.default=s}),98);
__d("LSGenerateTraceId",["LSRequestId","MetaConfig"],(function(t,n,r,o,a,i,l){"use strict";function e(){if(r("MetaConfig")._("62"))return r("LSRequestId").generate()}l.default=e}),98);
__d("LSGetLocalizedReplySnippet",["LSGetThreadParticipantDisplayName","LSGetViewerFBID","LSLocalize"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return t.storedProcedure(n("LSGetViewerFBID")).then(function(e){var t;return t=e,r[0]=t[0],t})},function(o){return t.i64.eq(e[3],t.i64.cast([0,1]))?t.sequence([function(o){return t.i64.eq(e[1],r[0])?t.sequence([function(o){return t.i64.eq(e[2],r[0])?t.sequence([function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,2421884758]),void 0).then(function(e){return r[4]=e})},function(e){return r[3]=r[4]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[2]).then(function(e){var t;return t=e,r[4]=t[0],t})},function(e){return r[5]=t.createArray(),r[7]=(r[5].push(r[4]),r[5]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2676961947]),r[5]).then(function(e){return r[6]=e})},function(e){return r[3]=r[6]}])},function(e){return r[2]=r[3]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[1]).then(function(e){var t;return t=e,r[3]=t[0],t})},function(o){return t.i64.eq(e[2],r[0])?t.sequence([function(e){return r[5]=t.createArray(),r[7]=(r[5].push(r[3]),r[5]),n("LSLocalize").localizeV2Async(t.i64.cast([0,3298086032]),r[5]).then(function(e){return r[6]=e})},function(e){return r[4]=r[6]}]):t.sequence([function(o){return t.i64.eq(e[1],e[2])?t.sequence([function(e){return r[6]=t.createArray(),r[8]=(r[6].push(r[3]),r[6]),n("LSLocalize").localizeV2Async(t.i64.cast([0,3873263038]),r[6]).then(function(e){return r[7]=e})},function(e){return r[5]=r[7]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[2]).then(function(e){var t;return t=e,r[6]=t[0],t})},function(e){return r[7]=t.createArray(),r[9]=(r[7].push(r[3]),r[7]),r[9]=(r[7].push(r[6]),r[7]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2616853333]),r[7]).then(function(e){return r[8]=e})},function(e){return r[5]=r[8]}])},function(e){return r[4]=r[5]}])},function(e){return r[2]=r[4]}])},function(e){return r[1]=r[2]}]):t.sequence([function(o){return t.i64.eq(e[1],r[0])?t.sequence([function(o){return t.i64.eq(e[2],r[0])?t.sequence([function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,4002265907]),void 0).then(function(e){return r[4]=e})},function(e){return r[3]=r[4]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[2]).then(function(e){var t;return t=e,r[4]=t[0],t})},function(e){return r[5]=t.createArray(),r[7]=(r[5].push(r[4]),r[5]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2663996736]),r[5]).then(function(e){return r[6]=e})},function(e){return r[3]=r[6]}])},function(e){return r[2]=r[3]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[1]).then(function(e){var t;return t=e,r[3]=t[0],t})},function(o){return t.i64.eq(e[2],r[0])?t.sequence([function(e){return r[5]=t.createArray(),r[7]=(r[5].push(r[3]),r[5]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2868699317]),r[5]).then(function(e){return r[6]=e})},function(e){return r[4]=r[6]}]):t.sequence([function(o){return t.i64.eq(e[1],e[2])?t.sequence([function(e){return r[6]=t.createArray(),r[8]=(r[6].push(r[3]),r[6]),n("LSLocalize").localizeV2Async(t.i64.cast([0,2688620547]),r[6]).then(function(e){return r[7]=e})},function(e){return r[5]=r[7]}]):t.sequence([function(o){return t.storedProcedure(n("LSGetThreadParticipantDisplayName"),e[0],e[2]).then(function(e){var t;return t=e,r[6]=t[0],t})},function(e){return r[7]=t.createArray(),r[9]=(r[7].push(r[3]),r[7]),r[9]=(r[7].push(r[6]),r[7]),n("LSLocalize").localizeV2Async(t.i64.cast([0,3544071775]),r[7]).then(function(e){return r[8]=e})},function(e){return r[5]=r[8]}])},function(e){return r[4]=r[5]}])},function(e){return r[2]=r[4]}])},function(e){return r[1]=r[2]}])},function(e){return o[0]=r[1]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxGetLocalizedReplySnippetStoredProcedure",e.__tables__=[],a.exports=e}),null);
__d("LSGetMessageAttributionParams",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(o){return t.sequence([function(r){return t.filter(t.db.table(31).fetch(),function(t){return t.offlineThreadingId===e[0]}).next().then(function(e,t){var r,o,a=e.done,i=e.value;return a?(r=[void 0,void 0,void 0],n[0]=r[0],n[1]=r[1],n[2]=r[2],r):(t=i.item,o=[t.threadAttributionSource,t.platformRef,t.platformToken],n[0]=o[0],n[1]=o[1],n[2]=o[2])})},function(e){var t;return t=[n[0],n[1],n[2]],r[0]=t[0],r[1]=t[1],r[2]=t[2],t}])},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMediaSendGetMessageAttributionParamsStoredProcedure",e.__tables__=["messages_optimistic_context"],a.exports=e}),null);
__d("LSInsertOptimisticAttachment",["LSSetMessageDisplayedContentTypes"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(r){return t.sequence([function(n){return t.forEach(t.filter(t.db.table(16).fetch([[[e[0],e[2],e[4]]]]),function(n){return t.i64.eq(n.threadKey,e[0])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&n.messageId===e[2]&&n.attachmentFbid===e[4]&&t.i64.lt(n.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(n){return t.db.table(16).add({threadKey:e[0],messageId:e[2],attachmentFbid:e[4],timestampMs:e[1],offlineAttachmentId:e[3],attachmentType:e[5],attachmentIndex:e[7],filename:e[6],attributionAppId:e[8],hasMedia:e[9],isSharable:!1,hasXma:e[10],authorityLevel:t.i64.cast([0,20])})},function(r){return t.storedProcedure(n("LSSetMessageDisplayedContentTypes"),e[0],e[2],e[1],void 0,!1,t.i64.eq(e[5],t.i64.cast([0,1]))||t.i64.eq(e[5],t.i64.cast([0,15])))}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxInsertOptimisticAttachmentStoredProcedure",e.__tables__=["attachments"],a.exports=e}),null);
__d("LSInsertPhase2PendingTask",["LSIssueNewTask"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return t.db.table(12).fetch([[[e[0]]],"optimistic"]).next().then(function(e,t){var n=e.done,o=e.value;return n?r[0]=void 0:(t=o.item,r[0]=t.threadKey)})},function(o){return t.i64.neq(r[0],void 0)?t.sequence([function(o){return t.storedProcedure(n("LSIssueNewTask"),[t.i64.to_string(r[0]),"_multi_media"].join(""),t.i64.cast([0,4]),e[0],void 0,void 0,e[1],t.i64.cast([0,0]),t.i64.cast([0,29]),void 0,t.i64.cast([0,0]),t.i64.cast([0,0]))},function(e){return r[2]=void 0}]):t.resolve(r[2]=t.i64.cast([0,1002]))},function(e){return o[0]=r[2]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMediaSendInsertPhase2PendingTaskStoredProcedure",e.__tables__=["messages"],a.exports=e}),null);
__d("LSIssueSendAttachmentMessageTask",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSIssueNewTaskWithExtraOperationsAndGetTaskID","LSPredefineTraceForTask"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(o){return r[0]=t.i64.of_int32(e[5].length),t.i64.gt(r[0],t.i64.cast([0,0]))?t.loopAsync(r[0],function(o){return r[7]=o,t.sequence([function(o){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),e[5],r[7]).then(function(e){var t;return t=e,r[8]=t[0],r[9]=t[1],t})},function(n){return t.forEach(t.filter(t.db.table(16).fetch([[[e[1],e[3]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&n.messageId===e[3]&&t.i64.eq(n.attachmentIndex,r[7])&&t.i64.eq(n.authorityLevel,t.i64.cast([0,20]))}),function(e){var n=e.update,o=e.item;return n({attachmentFbid:t.i64.to_string(r[8])})})}])}):t.resolve()},function(n){return e[9]?r[1]=t.i64.cast([0,9]):r[1]=t.i64.cast([0,3]),t.db.table(9).fetch([[[e[1]]]]).next().then(function(e,n){var o=e.done,a=e.value;return o?r[2]=t.i64.cast([0,1]):(n=a.item,r[8]=n.syncGroup,t.i64.neq(r[8],void 0)?r[7]=r[8]:r[7]=t.i64.cast([0,1]),r[2]=r[7])})},function(o){return t.storedProcedure(n("LSIssueNewTaskWithExtraOperationsAndGetTaskID"),t.i64.to_string(e[1]),t.i64.cast([0,46]),"",void 0,void 0,t.i64.cast([0,0]),t.i64.cast([0,0]),r[2],void 0,t.i64.cast([0,0]),void 0,t.i64.cast([0,0])).then(function(e){var t;return t=e,r[4]=t[0],t})},function(o){return e[12]!==void 0?t.sequence([function(o){return t.storedProcedure(n("LSPredefineTraceForTask"),e[12],r[4],t.i64.to_string(t.i64.cast([0,46])),e[3])},function(r){return t.storedProcedure(n("LSAppendDataTraceAddon"),e[12],t.i64.cast([0,20]),t.i64.cast([0,1]),void 0,void 0)}]):t.resolve()},function(n){return r[5]=new t.Map,r[6]=t.createArray(),t.db.table(31).add({taskId:r[4],threadKey:e[1],offlineThreadingId:e[3],threadAttributionSource:e[6],platformRef:e[10],platformToken:e[11],replySourceId:e[7],replySourceType:e[8],sendType:r[1],markThreadRead:!1,metadataDataclass:e[13]})}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxIssueSendAttachmentMessageTaskStoredProcedure",e.__tables__=["attachments","threads","messages_optimistic_context"],a.exports=e}),null);
__d("LSSetMessageViewFlags",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(r){return t.sequence([function(r){return t.filter(t.db.table(12).fetch([[[e[0],e[2],e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[0])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(n.timestampMs,e[2])&&n.messageId===e[1]}).next().then(function(e,r){var o,a,i=e.done,l=e.value;return i?(o=[t.i64.cast([0,0]),t.i64.cast([0,0]),t.i64.cast([0,0]),!1,"nonexistent",t.i64.cast([0,20]),void 0,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[0]=o[0],n[1]=o[1],n[2]=o[2],n[3]=o[3],n[4]=o[4],n[5]=o[5],n[6]=o[6],n[7]=o[7],n[8]=o[8],o):(r=l.item,a=[r.timestampMs,r.senderId,r.viewFlags,r.isAdminMessage,r.messageId,r.authorityLevel,r.stickerId,r.primarySortKey,r.secondarySortKey==null?t.i64.cast([-1,4294967295]):r.secondarySortKey],n[0]=a[0],n[1]=a[1],n[2]=a[2],n[3]=a[3],n[4]=a[4],n[5]=a[5],n[6]=a[6],n[7]=a[7],n[8]=a[8])})},function(r){return t.sortBy(t.filter(t.db.table(12).fetch([[[e[0],{gt:n[7]}],[e[0],n[7]]],"messageDisplayOrder"]),function(r){return t.i64.eq(r.threadKey,e[0])&&r.messageId!==e[1]&&(t.i64.gt(r.primarySortKey,n[7])||t.i64.eq(r.primarySortKey,n[7])&&t.i64.ge(r.secondarySortKey==null?t.i64.cast([-1,4294967295]):r.secondarySortKey,n[8]))}),[["timestampMs","ASC"]],["primarySortKey","secondarySortKey"]).next().then(function(e,r){var o,a,i=e.done,l=e.value;return i?(o=[t.i64.cast([0,0]),t.i64.cast([0,0]),t.i64.cast([0,0]),!1,"nonexistent",t.i64.cast([0,20]),void 0,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[10]=o[0],n[11]=o[1],n[12]=o[2],n[13]=o[3],n[14]=o[4],n[15]=o[5],n[16]=o[6],n[17]=o[7],n[18]=o[8],o):(r=l.item,a=[r.timestampMs,r.senderId,r.viewFlags,r.isAdminMessage,r.messageId,r.authorityLevel,r.stickerId,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[10]=a[0],n[11]=a[1],n[12]=a[2],n[13]=a[3],n[14]=a[4],n[15]=a[5],n[16]=a[6],n[17]=a[7],n[18]=a[8])})},function(r){return t.sortBy(t.filter(t.db.table(12).fetchDesc([[[e[0],{lt:n[7]}],[e[0],n[7]]],"messageDisplayOrder"]),function(r){return t.i64.eq(r.threadKey,e[0])&&r.messageId!==e[1]&&(t.i64.lt(r.primarySortKey,n[7])||t.i64.eq(r.primarySortKey,n[7])&&t.i64.le(r.secondarySortKey==null?t.i64.cast([-1,4294967295]):r.secondarySortKey,n[8]))}),[["timestampMs","DESC"]],["primarySortKey","secondarySortKey"]).next().then(function(e,r){var o,a,i=e.done,l=e.value;return i?(o=[t.i64.cast([0,0]),t.i64.cast([0,0]),t.i64.cast([0,0]),!1,"nonexistent",t.i64.cast([0,20]),void 0,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[20]=o[0],n[21]=o[1],n[22]=o[2],n[23]=o[3],n[24]=o[4],n[25]=o[5],n[26]=o[6],n[27]=o[7],n[28]=o[8],o):(r=l.item,a=[r.timestampMs,r.senderId,r.viewFlags,r.isAdminMessage,r.messageId,r.authorityLevel,r.stickerId,t.i64.cast([-1,4294967295]),t.i64.cast([-1,4294967295])],n[20]=a[0],n[21]=a[1],n[22]=a[2],n[23]=a[3],n[24]=a[4],n[25]=a[5],n[26]=a[6],n[27]=a[7],n[28]=a[8])})},function(r){return n[32]=t.i64.or_(t.i64.cast([0,2]),t.i64.or_(!n[3]&&!e[3]?t.i64.cast([0,4]):t.i64.cast([0,0]),t.i64.or_(n[3]?t.i64.cast([0,0]):t.i64.cast([0,1]),t.i64.or_(t.i64.eq(n[5],t.i64.cast([0,60]))||t.i64.eq(n[5],t.i64.cast([0,80]))?t.i64.cast([0,1048576]):t.i64.cast([0,0]),t.i64.neq(n[6],t.i64.cast([85970,924785702]))&&t.i64.neq(n[6],t.i64.cast([85970,1004785694]))&&t.i64.neq(n[6],t.i64.cast([85970,1044785690]))?t.i64.cast([0,0]):t.i64.cast([0,2097152]))))),n[14]!=="nonexistent"?t.sequence([function(r){return n[35]=t.i64.or_(t.i64.and_(n[12],t.i64.cast([-1,4294967280])),t.i64.or_(t.i64.gt(t.i64.sub(n[10],n[0]),t.i64.cast([0,6e5]))?t.i64.cast([0,2]):t.i64.cast([0,0]),t.i64.or_(t.i64.eq(n[11],n[1])&&!n[13]&&!n[3]&&!t.i64.gt(t.i64.sub(n[10],n[0]),t.i64.cast([0,6e5]))?t.i64.cast([0,8]):t.i64.cast([0,0]),t.i64.or_(!e[3]&&!n[13]&&!(t.i64.eq(n[11],n[1])&&!n[13]&&!n[3]&&!t.i64.gt(t.i64.sub(n[10],n[0]),t.i64.cast([0,6e5])))?t.i64.cast([0,4]):t.i64.cast([0,0]),t.i64.and_(n[12],t.i64.cast([0,1])))))),n[33]=t.i64.eq(t.i64.and_(n[35],t.i64.cast([0,8])),t.i64.cast([0,8])),n[34]=n[33]?t.i64.or_(n[32],t.i64.cast([0,16])):n[32],t.forEach(t.filter(t.db.table(12).fetch([[[e[0],n[10],n[14]]]]),function(r){return t.i64.eq(r.threadKey,e[0])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(r.timestampMs,n[10])&&r.messageId===n[14]}),function(e){var t=e.update,r=e.item;return t({viewFlags:n[35]})})},function(e){return n[30]=n[33]?t.i64.and_(n[34],t.i64.cast([-1,4294967294])):n[34]}]):t.resolve(n[30]=n[32])},function(r){return n[24]!=="nonexistent"?t.sequence([function(r){return n[35]=t.i64.or_(t.i64.and_(n[30],t.i64.cast([-1,4294967280])),t.i64.or_(t.i64.gt(t.i64.sub(n[0],n[20]),t.i64.cast([0,6e5]))?t.i64.cast([0,2]):t.i64.cast([0,0]),t.i64.or_(t.i64.eq(n[1],n[21])&&!n[3]&&!n[23]&&!t.i64.gt(t.i64.sub(n[0],n[20]),t.i64.cast([0,6e5]))?t.i64.cast([0,8]):t.i64.cast([0,0]),t.i64.or_(!e[3]&&!n[3]&&!(t.i64.eq(n[1],n[21])&&!n[3]&&!n[23]&&!t.i64.gt(t.i64.sub(n[0],n[20]),t.i64.cast([0,6e5])))?t.i64.cast([0,4]):t.i64.cast([0,0]),t.i64.and_(n[30],t.i64.cast([0,1])))))),n[33]=t.i64.eq(t.i64.and_(n[35],t.i64.cast([0,8])),t.i64.cast([0,8])),n[34]=n[33]?t.i64.or_(n[22],t.i64.cast([0,16])):n[22],t.forEach(t.filter(t.db.table(12).fetch([[[e[0],n[20],n[24]]]]),function(r){return t.i64.eq(r.threadKey,e[0])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(r.timestampMs,n[20])&&r.messageId===n[24]}),function(e){var r=e.update,o=e.item;return r({viewFlags:n[33]?t.i64.and_(n[34],t.i64.cast([-1,4294967294])):n[34]})})},function(e){return n[31]=n[35]}]):t.resolve(n[31]=n[30])},function(r){return t.forEach(t.filter(t.db.table(12).fetch([[[e[0],n[0],n[4]]]]),function(r){return t.i64.eq(r.threadKey,e[0])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(r.timestampMs,n[0])&&r.messageId===n[4]}),function(e){var t=e.update,r=e.item;return t({viewFlags:n[31]})})}])},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxSetMessageViewFlagsStoredProcedure",e.__tables__=["messages"],a.exports=e}),null);
__d("LSLocalApplyOptimisticMessage",["LSArrayGetObjectAt","LSCreateOfflineThreadingID","LSGetLocalizedReplySnippet","LSIssueNewError","LSLocalize","LSSetMessageDisplayedContentTypes","LSSetMessageViewFlags"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return r[0]=t.i64.of_float(Date.now()),t.sequence([function(e){return t.storedProcedure(n("LSCreateOfflineThreadingID"),r[0]).then(function(e){var t;return t=e,r[9]=t[0],t})},function(e){return r[1]=t.i64.to_string(r[9])}])},function(o){return r[8]=e[4]==null?e[3]:e[4],t.sequence([function(e){return t.islc(t.db.table(9).fetchDesc([[[]],"lastActivityTimestampMs"]),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o=e.done,a=e.value;return o?r[9]=t.i64.cast([-1,4294967295]):(n=a.item,r[9]=n.lastActivityTimestampMs)})},function(o){return r[11]=t.i64.add(r[9],t.i64.cast([0,1])),r[13]=t.i64.gt(r[0],r[11])?r[0]:r[11],t.db.table(9).fetch([[[e[1]]]]).next().then(function(o,a){var i=o.done,l=o.value;return i?t.sequence([function(n){return(function(e){t.logger(e).info(e)})("localApplyOptimisticMessage insert optimistic thread"),t.forEach(t.filter(t.db.table(9).fetch([[[e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.lt(n.authorityLevel,t.i64.cast([0,40]))}),function(e){return e.delete()})},function(n){return t.db.table(9).add({threadKey:e[1],mailboxType:t.i64.cast([0,0]),threadType:e[2],clientThreadKey:e[1],folderName:"inbox",parentThreadKey:t.i64.cast([0,0]),lastActivityTimestampMs:r[13],lastReadWatermarkTimestampMs:r[13],snippet:r[8],snippetHasEmoji:e[5]==null?!1:e[5],snippetSenderContactId:e[0],ongoingCallState:t.i64.cast([0,0]),authorityLevel:t.i64.cast([0,40])})},function(n){return t.i64.eq(e[2],t.i64.cast([0,13]))||t.i64.eq(e[2],t.i64.cast([0,7]))||t.i64.eq(e[2],t.i64.cast([0,1]))?t.sequence([function(n){return t.forEach(t.filter(t.db.table(14).fetch([[[e[1],e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(n.contactId,e[1])&&t.i64.lt(n.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(n){return t.db.table(14).add({threadKey:e[1],contactId:e[1],readWatermarkTimestampMs:t.i64.cast([0,0]),deliveredWatermarkTimestampMs:t.i64.cast([0,0]),authorityLevel:t.i64.cast([0,20]),isModerator:!1})}]):t.resolve()},function(e){return t.sortBy(t.db.table(115).fetch(),[["timestampMs","DESC"]]).next().then(function(e,t){var n=e.done,o=e.value;return n?r[14]=!1:(t=o.item,r[14]=t.errorShouldBeShown)})},function(e){return r[14]===!0?t.sequence([function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,2285622730]),void 0).then(function(e){return r[16]=e})},function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,1919524925]),void 0).then(function(e){return r[17]=e})},function(e){return t.storedProcedure(n("LSIssueNewError"),void 0,t.i64.cast([0,1545093]),r[16],r[17],void 0,void 0)}]):t.resolve()}]):(a=l.item,t.forEach(t.filter(t.db.table(9).fetch([[[e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.eq(n.threadType,e[2])}),function(t){var n=t.update,o=t.item;return n({lastActivityTimestampMs:r[13],lastReadWatermarkTimestampMs:r[13],snippet:r[8],snippetHasEmoji:e[5]==null?!1:e[5],snippetSenderContactId:e[0],snippetText:void 0,snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,additionalThreadContext:void 0})}))})}])},function(o){return t.sequence([function(n){return t.islc(t.db.table(12).fetchDesc([[[e[1],t.i64.cast([0,80])],[e[1],t.i64.cast([0,60])],[e[1],t.i64.cast([0,40])]],"messageDisplayOrderAuthority"]),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o=e.done,a=e.value;return o?(r[33]=t.i64.of_float(Date.now()),r[9]=r[33]):(n=a.item,r[9]=n.primarySortKey)})},function(o){var a,i,l;return e[8]!==void 0&&(t.i64.eq(e[9],t.i64.cast([0,1]))||t.i64.eq(e[10],t.i64.cast([0,1])))?t.sequence([function(o){return t.filter(t.db.table(12).fetch([[[e[8]==null?"":e[8]]],"messageId"]),function(n){return t.i64.eq(n.threadKey,e[1])&&n.messageId===(e[8]==null?"":e[8])}).next().then(function(o,a){var i,l=o.done,s=o.value;return l?(i=[e[8],void 0,void 0,t.i64.cast([0,0]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[33]=i[0],r[34]=i[1],r[35]=i[2],r[36]=i[3],r[37]=i[4],r[38]=i[5],r[39]=i[6],r[40]=i[7],r[41]=i[8],r[42]=i[9],r[43]=i[10],r[44]=i[11],r[45]=i[12],r[46]=i[13],r[47]=i[14],r[48]=i[15],i):(a=s.item,t.sequence([function(e){return r[54]=a.senderId,r[53]=a.stickerId,t.sequence([function(e){return r[56]=t.createArray(),r[57]=r[56],t.forEach(t.filter(t.db.table(16).fetch([[[a.threadKey,a.messageId]]]),function(e){return a.messageId===e.messageId&&t.i64.eq(a.threadKey,e.threadKey)&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))}),function(e){var t=e.item;return r[60]=(r[57].push(t.attachmentType),r[57]),r[57]=r[57]})},function(e){var o;return t.i64.neq(r[53],void 0)?t.resolve((o=[r[53],t.i64.cast([0,4])],r[58]=o[0],r[59]=o[1],o)):t.sequence([function(e){return r[60]=!1,r[61]=t.i64.of_int32(r[57].length),t.i64.gt(r[61],t.i64.cast([0,0]))?t.loopAsync(r[61],function(e){return r[63]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[57],r[63]).then(function(e){var t;return t=e,r[64]=t[0],r[65]=t[1],t})},function(e){return r[60]=r[60]||t.i64.eq(t.i64.cast([0,4]),r[64])}])}):t.resolve()},function(e){return r[60]?t.resolve(r[62]=t.i64.cast([0,2])):t.sequence([function(e){return r[63]=!1,r[64]=t.i64.of_int32(r[57].length),t.i64.gt(r[64],t.i64.cast([0,0]))?t.loopAsync(r[64],function(e){return r[66]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[57],r[66]).then(function(e){var t;return t=e,r[67]=t[0],r[68]=t[1],t})},function(e){return r[63]=r[63]||t.i64.eq(t.i64.cast([0,2]),r[67])}])}):t.resolve()},function(e){return r[63]?t.resolve(r[65]=t.i64.cast([0,1])):t.sequence([function(e){return r[66]=!1,r[67]=t.i64.of_int32(r[57].length),t.i64.gt(r[67],t.i64.cast([0,0]))?t.loopAsync(r[67],function(e){return r[69]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[57],r[69]).then(function(e){var t;return t=e,r[70]=t[0],r[71]=t[1],t})},function(e){return r[66]=r[66]||t.i64.eq(t.i64.cast([0,3]),r[70])}])}):t.resolve()},function(e){return r[66]?t.resolve(r[68]=t.i64.cast([0,3])):t.sequence([function(e){return r[69]=!1,r[70]=t.i64.of_int32(r[57].length),t.i64.gt(r[70],t.i64.cast([0,0]))?t.loopAsync(r[70],function(e){return r[72]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[57],r[72]).then(function(e){var t;return t=e,r[73]=t[0],r[74]=t[1],t})},function(e){return r[69]=r[69]||t.i64.eq(t.i64.cast([0,15]),r[73])}])}):t.resolve()},function(e){return r[69]?r[71]=t.i64.cast([0,19]):(r[72]=t.i64.of_int32(r[57].length),t.i64.eq(r[72],t.i64.cast([0,0]))?r[73]=void 0:r[73]=t.i64.cast([0,0]),r[71]=r[73]),r[68]=r[71]}])},function(e){return r[65]=r[68]}])},function(e){return r[62]=r[65]}])},function(e){var t;return t=[void 0,r[62]],r[58]=t[0],r[59]=t[1],t}])},function(e){var t;return t=[r[58],r[59]],r[50]=t[0],r[51]=t[1],t}])},function(o){return r[55]=a.replyType==null?t.i64.cast([0,0]):a.replyType,t.sequence([function(o){return t.storedProcedure(n("LSGetLocalizedReplySnippet"),e[1],e[0],r[54],r[55]).then(function(e){var t;return t=e,r[56]=t[0],t})},function(n){return r[52]=t.i64.eq(e[10],t.i64.cast([0,1]))?r[56]:""}])},function(n){var o;return o=[e[8],e[9],e[10],t.i64.cast([0,1]),r[52],r[54],a.text,r[50],r[51],void 0,void 0,void 0,void 0,void 0,void 0,r[55]],r[33]=o[0],r[34]=o[1],r[35]=o[2],r[36]=o[3],r[37]=o[4],r[38]=o[5],r[39]=o[6],r[40]=o[7],r[41]=o[8],r[42]=o[9],r[43]=o[10],r[44]=o[11],r[45]=o[12],r[46]=o[13],r[47]=o[14],r[48]=o[15],o}]))})},function(e){var t;return t=[r[33],r[34],r[35],r[36],r[37],r[38],r[39],r[40],r[41],r[42],r[43],r[44],r[45],r[46],r[47],r[48]],r[11]=t[0],r[12]=t[1],r[13]=t[2],r[14]=t[3],r[15]=t[4],r[16]=t[5],r[17]=t[6],r[18]=t[7],r[19]=t[8],r[20]=t[9],r[21]=t[10],r[22]=t[11],r[23]=t[12],r[24]=t[13],r[25]=t[14],r[26]=t[15],t}]):t.resolve((e[8]===void 0||t.i64.eq(e[9],t.i64.cast([0,0]))||t.i64.eq(e[10],t.i64.cast([0,0]))?(a=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[33]=a[0],r[34]=a[1],r[35]=a[2],r[36]=a[3],r[37]=a[4],r[38]=a[5],r[39]=a[6],r[40]=a[7],r[41]=a[8],r[42]=a[9],r[43]=a[10],r[44]=a[11],r[45]=a[12],r[46]=a[13],r[47]=a[14],r[48]=a[15]):(i=[e[8],e[9],e[10],t.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[33]=i[0],r[34]=i[1],r[35]=i[2],r[36]=i[3],r[37]=i[4],r[38]=i[5],r[39]=i[6],r[40]=i[7],r[41]=i[8],r[42]=i[9],r[43]=i[10],r[44]=i[11],r[45]=i[12],r[46]=i[13],r[47]=i[14],r[48]=i[15]),l=[r[33],r[34],r[35],r[36],r[37],r[38],r[39],r[40],r[41],r[42],r[43],r[44],r[45],r[46],r[47],r[48]],r[11]=l[0],r[12]=l[1],r[13]=l[2],r[14]=l[3],r[15]=l[4],r[16]=l[5],r[17]=l[6],r[18]=l[7],r[19]=l[8],r[20]=l[9],r[21]=l[10],r[22]=l[11],r[23]=l[12],r[24]=l[13],r[25]=l[14],r[26]=l[15]))},function(n){var o,a;return e[13]?r[27]=!1:r[27]=!0,r[27]?(a=[void 0,void 0,void 0,void 0],r[28]=a[0],r[29]=a[1],r[30]=a[2],r[31]=a[3]):(r[33]=e[13].get("mention_offsets"),r[34]=e[13].get("mention_lengths"),r[35]=e[13].get("mention_ids"),r[36]=e[13].get("mention_types"),o=[r[33],r[34],r[35],r[36]],r[28]=o[0],r[29]=o[1],r[30]=o[2],r[31]=o[3]),e[11]?r[32]=t.i64.cast([0,3]):r[32]=r[13],t.i64.eq(t.i64.cast([0,20]),t.i64.cast([0,20]))?t.db.table(12).add({threadKey:e[1],messageId:r[1],timestampMs:r[0],offlineThreadingId:r[1],primarySortKey:r[9],secondarySortKey:r[0],text:e[3],senderId:e[0],stickerId:e[6],hotEmojiSize:e[7],isForwarded:e[11],forwardScore:e[12],isAdminMessage:!1,sendStatus:t.i64.cast([0,1]),sendStatusV2:t.i64.cast([0,1]),authorityLevel:t.i64.cast([0,20]),replySourceId:r[11],replySourceType:r[12],replySourceTypeV2:r[32],replyStatus:r[14],replySnippet:r[15],replyToUserId:r[16],replyMessageText:r[17],replyAttachmentId:r[18],replyAttachmentType:r[19],replyMediaUrl:r[20],replyMediaUrlFallback:r[21],replyMediaPreviewWidth:r[22],replyMediaPreviewHeight:r[23],replyMediaUrlMimeType:r[24],replyType:r[26],mentionOffsets:r[28],mentionLengths:r[29],mentionIds:r[30],mentionTypes:r[31]}):t.sequence([function(e){return t.db.table(12).fetch([[[r[1]]],"optimistic"]).next().then(function(e,t){var n,o,a=e.done,i=e.value;return a?(n=[r[9],r[0],void 0],r[33]=n[0],r[34]=n[1],r[35]=n[2],n):(t=i.item,o=[t.primarySortKey,t.secondarySortKey,t.localDataId],r[33]=o[0],r[34]=o[1],r[35]=o[2])})},function(e){return t.forEach(t.filter(t.db.table(12).fetch([[[r[1]]],"optimistic"]),function(e){return e.offlineThreadingId===r[1]&&t.i64.lt(e.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(n){return t.db.table(12).add({threadKey:e[1],messageId:r[1],timestampMs:r[0],offlineThreadingId:r[1],primarySortKey:r[33],secondarySortKey:r[34],text:e[3],senderId:e[0],stickerId:e[6],hotEmojiSize:e[7],isForwarded:e[11],forwardScore:e[12],isAdminMessage:!1,sendStatus:t.i64.cast([0,1]),sendStatusV2:t.i64.cast([0,1]),authorityLevel:t.i64.cast([0,20]),localDataId:r[35],replySourceId:r[11],replySourceType:r[12],replySourceTypeV2:r[32],replyStatus:r[14],replySnippet:r[15],replyToUserId:r[16],replyMessageText:r[17],replyAttachmentId:r[18],replyAttachmentType:r[19],replyMediaUrl:r[20],replyMediaUrlFallback:r[21],replyMediaPreviewWidth:r[22],replyMediaPreviewHeight:r[23],replyMediaUrlMimeType:r[24],replyType:r[26],mentionOffsets:r[28],mentionLengths:r[29],mentionIds:r[30],mentionTypes:r[31]})}])}])},function(o){return r[2]=t.createArray(),r[3]=(r[2].push("LSMailboxLocalApplyOptimisticMessageStoredProcedure"),r[2]),r[4]=(r[2].push("localApplyOptimisticMessage"),r[2]),r[5]=(r[2].push(e[1]),r[2]),r[6]=(r[2].push(r[1]),r[2]),r[7]=t.toJSON(r[2]),(function(e){t.logger(e).info(e)})(r[7]),e[14]?t.sequence([function(o){return t.storedProcedure(n("LSSetMessageViewFlags"),e[1],r[1],r[0],t.i64.eq(e[2],t.i64.cast([0,1])))},function(o){return t.storedProcedure(n("LSSetMessageDisplayedContentTypes"),e[1],r[1],r[0],e[3],!1,t.i64.neq(e[6],void 0))}]):t.resolve()},function(e){var t;return t=[r[1],r[0]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxLocalApplyOptimisticMessageStoredProcedure",e.__tables__=["threads","participants","user_visible_network_connectivity_error","messages","attachments"],a.exports=e}),null);
__d("LSLocalApplyOptimisticMessageV2",["LSArrayGetObjectAt","LSCreateOfflineThreadingID","LSDeserializeFromJsonIntoDictionaryV2.nop","LSGetLocalizedReplySnippet","LSIssueNewError","LSLocalize","LSSetMessageDisplayedContentTypes","LSSetMessageViewFlags"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(e){return r[0]=t.i64.of_float(Date.now()),t.storedProcedure(n("LSCreateOfflineThreadingID"),r[0]).then(function(e){var t;return t=e,r[1]=t[0],t})},function(o){return r[4]=t.i64.to_string(r[1]),r[3]=e[4]==null?e[3]:e[4],t.sequence([function(n){return r[5]=e[5].get("snippet_has_emoji"),t.islc(t.db.table(9).fetchDesc([[[]],"lastActivityTimestampMs"]),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o=e.done,a=e.value;return o?r[6]=t.i64.cast([-1,4294967295]):(n=a.item,r[6]=n.lastActivityTimestampMs)})},function(o){return r[8]=t.i64.add(r[6],t.i64.cast([0,1])),r[10]=t.i64.gt(r[0],r[8])?r[0]:r[8],t.db.table(9).fetch([[[e[1]]]]).next().then(function(o,a){var i=o.done,l=o.value;return i?t.sequence([function(n){return(function(e){t.logger(e).info(e)})("localApplyOptimisticMessage insert optimistic thread"),t.i64.eq(e[2],t.i64.cast([0,1]))?t.sequence([function(n){return t.filter(t.db.table(7).fetch([[[e[1]]]]),function(n){return t.i64.eq(n.id,e[1])&&t.i64.eq(t.i64.cast([0,1]),t.i64.cast([0,1]))}).next().then(function(e,n){var o=e.done,a=e.value;return o?r[16]=!1:(n=a.item,r[19]=n.capabilities2,t.i64.neq(r[19],void 0)?r[18]=r[19]:r[18]=t.i64.cast([0,0]),r[16]=t.i64.neq(t.i64.and_(r[18],t.i64.cast([0,4096])),t.i64.cast([0,0])))})},function(e){return r[11]=r[16]}]):t.resolve(r[11]=!1)},function(n){return r[11]?r[12]="e2ee_cutover":r[12]="inbox",r[11]?r[13]=t.i64.cast([-1,4294967279]):r[13]=t.i64.cast([0,0]),t.forEach(t.filter(t.db.table(9).fetch([[[e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.lt(n.authorityLevel,t.i64.cast([0,40]))}),function(e){return e.delete()})},function(n){return t.db.table(9).add({threadKey:e[1],mailboxType:t.i64.cast([0,0]),threadType:e[2],clientThreadKey:e[1],folderName:r[12],parentThreadKey:r[13],lastActivityTimestampMs:r[10],lastReadWatermarkTimestampMs:r[10],snippet:r[3],snippetHasEmoji:r[5]==null?!1:r[5],snippetSenderContactId:e[0],ongoingCallState:t.i64.cast([0,0]),authorityLevel:t.i64.cast([0,40])})},function(n){return t.i64.eq(e[2],t.i64.cast([0,13]))||t.i64.eq(e[2],t.i64.cast([0,7]))||t.i64.eq(e[2],t.i64.cast([0,1]))?t.sequence([function(n){return t.forEach(t.filter(t.db.table(14).fetch([[[e[1],e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&t.i64.eq(n.contactId,e[1])&&t.i64.lt(n.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(n){return t.db.table(14).add({threadKey:e[1],contactId:e[1],readWatermarkTimestampMs:t.i64.cast([0,0]),deliveredWatermarkTimestampMs:t.i64.cast([0,0]),authorityLevel:t.i64.cast([0,20]),isModerator:!1})}]):t.resolve()},function(e){return t.sortBy(t.db.table(115).fetch(),[["timestampMs","DESC"]]).next().then(function(e,t){var n=e.done,o=e.value;return n?r[14]=!1:(t=o.item,r[14]=t.errorShouldBeShown)})},function(e){return r[14]===!0?t.sequence([function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,2285622730]),void 0).then(function(e){return r[16]=e})},function(e){return n("LSLocalize").localizeV2Async(t.i64.cast([0,1919524925]),void 0).then(function(e){return r[17]=e})},function(e){return t.storedProcedure(n("LSIssueNewError"),void 0,t.i64.cast([0,1545093]),r[16],r[17],void 0,void 0)}]):t.resolve()}]):(a=l.item,t.forEach(t.filter(t.db.table(9).fetch([[[e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.eq(n.threadType,e[2])}),function(t){var n=t.update,o=t.item;return n({lastActivityTimestampMs:r[10],lastReadWatermarkTimestampMs:r[10],snippet:r[3],snippetHasEmoji:r[5]==null?!1:r[5],snippetSenderContactId:e[0],snippetStringHash:void 0,snippetStringArgument1:void 0,snippetAttribution:void 0,snippetAttributionStringHash:void 0,additionalThreadContext:void 0})}))})}])},function(o){return t.sequence([function(n){return t.islc(t.db.table(12).fetchDesc([[[e[1],t.i64.cast([0,80])],[e[1],t.i64.cast([0,60])],[e[1],t.i64.cast([0,40])]],"messageDisplayOrderAuthority"]),0,t.i64.to_float(t.i64.cast([0,1]))).next().then(function(e,n){var o=e.done,a=e.value;return o?(r[59]=t.i64.of_float(Date.now()),r[5]=r[59]):(n=a.item,r[5]=n.primarySortKey)})},function(o){var a,i,l;return r[7]=e[5].get("reply_source_id"),r[8]=e[5].get("reply_source_type"),r[9]=e[5].get("reply_source_type_v2"),r[10]=e[5].get("reply_type"),r[7]!==void 0&&(t.i64.eq(r[8],t.i64.cast([0,1]))||t.i64.eq(r[9],t.i64.cast([0,1])))?t.sequence([function(o){return t.filter(t.db.table(12).fetch([[[r[7]==null?"":r[7]]],"messageId"]),function(n){return t.i64.eq(n.threadKey,e[1])&&n.messageId===(r[7]==null?"":r[7])}).next().then(function(o,a){var i,l=o.done,s=o.value;return l?(i=[r[7],void 0,void 0,t.i64.cast([0,0]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[59]=i[0],r[60]=i[1],r[61]=i[2],r[62]=i[3],r[63]=i[4],r[64]=i[5],r[65]=i[6],r[66]=i[7],r[67]=i[8],r[68]=i[9],r[69]=i[10],r[70]=i[11],r[71]=i[12],r[72]=i[13],r[73]=i[14],r[74]=i[15],i):(a=s.item,t.sequence([function(e){return r[80]=a.senderId,r[79]=a.stickerId,t.sequence([function(e){return r[81]=t.createArray(),r[82]=r[81],t.forEach(t.filter(t.db.table(16).fetch([[[a.threadKey,a.messageId]]]),function(e){return a.messageId===e.messageId&&t.i64.eq(a.threadKey,e.threadKey)&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))}),function(e){var t=e.item;return r[85]=(r[82].push(t.attachmentType),r[82]),r[82]=r[82]})},function(e){var o;return t.i64.neq(r[79],void 0)?t.resolve((o=[r[79],t.i64.cast([0,4])],r[83]=o[0],r[84]=o[1],o)):t.sequence([function(e){return r[85]=!1,r[86]=t.i64.of_int32(r[82].length),t.i64.gt(r[86],t.i64.cast([0,0]))?t.loopAsync(r[86],function(e){return r[88]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[82],r[88]).then(function(e){var t;return t=e,r[89]=t[0],r[90]=t[1],t})},function(e){return r[85]=r[85]||t.i64.eq(t.i64.cast([0,4]),r[89])}])}):t.resolve()},function(e){return r[85]?t.resolve(r[87]=t.i64.cast([0,2])):t.sequence([function(e){return r[88]=!1,r[89]=t.i64.of_int32(r[82].length),t.i64.gt(r[89],t.i64.cast([0,0]))?t.loopAsync(r[89],function(e){return r[91]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[82],r[91]).then(function(e){var t;return t=e,r[92]=t[0],r[93]=t[1],t})},function(e){return r[88]=r[88]||t.i64.eq(t.i64.cast([0,2]),r[92])}])}):t.resolve()},function(e){return r[88]?t.resolve(r[90]=t.i64.cast([0,1])):t.sequence([function(e){return r[91]=!1,r[92]=t.i64.of_int32(r[82].length),t.i64.gt(r[92],t.i64.cast([0,0]))?t.loopAsync(r[92],function(e){return r[94]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[82],r[94]).then(function(e){var t;return t=e,r[95]=t[0],r[96]=t[1],t})},function(e){return r[91]=r[91]||t.i64.eq(t.i64.cast([0,3]),r[95])}])}):t.resolve()},function(e){return r[91]?t.resolve(r[93]=t.i64.cast([0,3])):t.sequence([function(e){return r[94]=!1,r[95]=t.i64.of_int32(r[82].length),t.i64.gt(r[95],t.i64.cast([0,0]))?t.loopAsync(r[95],function(e){return r[97]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[82],r[97]).then(function(e){var t;return t=e,r[98]=t[0],r[99]=t[1],t})},function(e){return r[94]=r[94]||t.i64.eq(t.i64.cast([0,15]),r[98])}])}):t.resolve()},function(e){return r[94]?r[96]=t.i64.cast([0,19]):(r[97]=t.i64.of_int32(r[82].length),t.i64.eq(r[97],t.i64.cast([0,0]))?r[98]=void 0:r[98]=t.i64.cast([0,0]),r[96]=r[98]),r[93]=r[96]}])},function(e){return r[90]=r[93]}])},function(e){return r[87]=r[90]}])},function(e){var t;return t=[void 0,r[87]],r[83]=t[0],r[84]=t[1],t}])},function(e){var t;return t=[r[83],r[84]],r[76]=t[0],r[77]=t[1],t}])},function(o){return t.sequence([function(o){return t.storedProcedure(n("LSGetLocalizedReplySnippet"),e[1],e[0],r[80],r[10]==null?t.i64.cast([0,0]):r[10]).then(function(e){var t;return t=e,r[81]=t[0],t})},function(e){return r[78]=t.i64.eq(r[9],t.i64.cast([0,1]))?r[81]:""}])},function(e){var n;return n=[r[7],r[8],r[9],t.i64.cast([0,1]),r[78],r[80],a.text,r[76],r[77],void 0,void 0,void 0,void 0,void 0,void 0,r[10]],r[59]=n[0],r[60]=n[1],r[61]=n[2],r[62]=n[3],r[63]=n[4],r[64]=n[5],r[65]=n[6],r[66]=n[7],r[67]=n[8],r[68]=n[9],r[69]=n[10],r[70]=n[11],r[71]=n[12],r[72]=n[13],r[73]=n[14],r[74]=n[15],n}]))})},function(e){var t;return t=[r[59],r[60],r[61],r[62],r[63],r[64],r[65],r[66],r[67],r[68],r[69],r[70],r[71],r[72],r[73],r[74]],r[11]=t[0],r[12]=t[1],r[13]=t[2],r[14]=t[3],r[15]=t[4],r[16]=t[5],r[17]=t[6],r[18]=t[7],r[19]=t[8],r[20]=t[9],r[21]=t[10],r[22]=t[11],r[23]=t[12],r[24]=t[13],r[25]=t[14],r[26]=t[15],t}]):t.resolve((r[7]===void 0||t.i64.eq(r[8],t.i64.cast([0,0]))||t.i64.eq(r[9],t.i64.cast([0,0]))?(a=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[59]=a[0],r[60]=a[1],r[61]=a[2],r[62]=a[3],r[63]=a[4],r[64]=a[5],r[65]=a[6],r[66]=a[7],r[67]=a[8],r[68]=a[9],r[69]=a[10],r[70]=a[11],r[71]=a[12],r[72]=a[13],r[73]=a[14],r[74]=a[15]):(i=[r[7],r[8],r[9],t.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[59]=i[0],r[60]=i[1],r[61]=i[2],r[62]=i[3],r[63]=i[4],r[64]=i[5],r[65]=i[6],r[66]=i[7],r[67]=i[8],r[68]=i[9],r[69]=i[10],r[70]=i[11],r[71]=i[12],r[72]=i[13],r[73]=i[14],r[74]=i[15]),l=[r[59],r[60],r[61],r[62],r[63],r[64],r[65],r[66],r[67],r[68],r[69],r[70],r[71],r[72],r[73],r[74]],r[11]=l[0],r[12]=l[1],r[13]=l[2],r[14]=l[3],r[15]=l[4],r[16]=l[5],r[17]=l[6],r[18]=l[7],r[19]=l[8],r[20]=l[9],r[21]=l[10],r[22]=l[11],r[23]=l[12],r[24]=l[13],r[25]=l[14],r[26]=l[15]))},function(o){var a,i,l,s;return r[27]=e[5].get("mention_data"),r[27]?r[28]=!1:r[28]=!0,r[28]?(i=[void 0,void 0,void 0,void 0],r[29]=i[0],r[30]=i[1],r[31]=i[2],r[32]=i[3]):(r[59]=r[27].get("mention_offsets"),r[60]=r[27].get("mention_lengths"),r[61]=r[27].get("mention_ids"),r[62]=r[27].get("mention_types"),a=[r[59],r[60],r[61],r[62]],r[29]=a[0],r[30]=a[1],r[31]=a[2],r[32]=a[3]),r[33]=e[5].get("magic_words_data"),r[33]?r[34]=!1:r[34]=!0,r[34]?(s=[void 0,void 0],r[35]=s[0],r[36]=s[1]):(r[59]=r[33].get("magic_word_offsets"),r[60]=r[33].get("magic_word_lengths"),l=[r[59],r[60]],r[35]=l[0],r[36]=l[1]),r[58]=t.i64.eq(r[10],t.i64.cast([0,1]))?r[17]:e[3],r[37]=e[5].get("sticker_id"),r[38]=e[5].get("sticker_alt_text"),r[39]=e[5].get("hot_emoji_size"),r[40]=e[5].get("iout"),r[41]=e[5].get("platform_XMD_encoded"),r[42]=e[5].get("is_forwarded"),r[43]=e[5].get("forward_score"),r[44]=e[5].get("power_up_style"),r[45]=e[5].get("local_data_id"),r[46]=e[5].get("command_type"),r[47]=e[5].get("reply_type"),r[48]=e[5].get("ephemeral_duration_in_sec"),r[49]=e[5].get("subthread_parent_message_id"),r[50]=e[5].get("is_exclusive_to_subthread"),e[6]!==void 0?t.sequence([function(o){return t.nativeOperation(n("LSDeserializeFromJsonIntoDictionaryV2.nop"),e[6]).then(function(e){var t;return t=e,r[59]=t[0],t})},function(e){return r[60]=new t.Map,r[61]=r[59].keys(),r[62]=t.i64.of_int32(r[61].length),t.i64.gt(r[62],t.i64.cast([0,0]))?t.loopAsync(r[62],function(e){return r[67]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[61],r[67]).then(function(e){var t;return t=e,r[68]=t[0],r[69]=t[1],t})},function(e){return r[70]=r[59].get(r[68]),r[60].set(r[68],r[70])}])}):t.resolve()},function(e){return r[63]=r[60].get("ai_metadata"),r[63]?r[64]=!1:r[64]=!0,r[64]?t.resolve(r[65]=void 0):t.sequence([function(e){return r[67]=new t.Map,r[68]=r[63].keys(),r[69]=t.i64.of_int32(r[68].length),t.i64.gt(r[69],t.i64.cast([0,0]))?t.loopAsync(r[69],function(e){return r[70]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[68],r[70]).then(function(e){var t;return t=e,r[71]=t[0],r[72]=t[1],t})},function(e){return r[73]=r[63].get(r[71]),r[67].set(r[71],r[73])}])}):t.resolve()},function(e){return r[65]=r[67]}])},function(e){return r[65]!==void 0?(r[67]=r[65].get("ai_product"),r[66]=r[67]):r[66]=void 0,r[51]=r[66]}]):t.resolve(r[51]=void 0)},function(n){return r[52]=e[5].get("rich_text_format_type"),t.i64.eq(r[52],t.i64.cast([0,1]))?r[53]=t.i64.cast([0,3]):(r[51]==="HIDDEN_METADATA"?r[59]=t.i64.cast([0,2]):r[59]=t.i64.cast([0,0]),r[53]=r[59]),r[54]=e[5].get("is_forwarded"),r[54]?r[55]=t.i64.cast([0,3]):r[55]=r[13],r[56]=e[5].get("plugin_type"),t.i64.eq(r[56],t.i64.cast([0,40]))?r[57]="Instamadillo":r[57]="FBBroker",t.i64.eq(t.i64.cast([0,20]),t.i64.cast([0,20]))?t.db.table(12).add({threadKey:e[1],messageId:r[4],timestampMs:r[0],offlineThreadingId:r[4],primarySortKey:r[5],secondarySortKey:r[0],text:r[58],senderId:e[0],stickerId:r[37],hotEmojiSize:r[39],platformXmdEncoded:r[41],isForwarded:r[42],forwardScore:r[43],isAdminMessage:!1,sendStatus:t.i64.cast([0,1]),sendStatusV2:t.i64.cast([0,1]),authorityLevel:t.i64.cast([0,20]),localDataId:r[45],replyType:r[26],ephemeralDurationInSec:r[48],subthreadParentMessageId:r[49],isExclusiveToSubthread:r[50],metadataDataclass:e[6],messageRenderingType:r[53],replySourceId:r[11],replySourceType:r[12],replySourceTypeV2:r[55],replyStatus:r[14],replySnippet:r[15],replyToUserId:r[16],replyMessageText:r[17],replyAttachmentId:r[18],replyAttachmentType:r[19],replyMediaUrl:r[20],replyMediaUrlFallback:r[21],replyMediaPreviewWidth:r[22],replyMediaPreviewHeight:r[23],replyMediaUrlMimeType:r[24],mentionOffsets:r[29],mentionLengths:r[30],mentionIds:r[31],mentionTypes:r[32],transportKey:r[57]}):t.sequence([function(e){return t.db.table(12).fetch([[[r[4]]],"optimistic"]).next().then(function(e,t){var n,o,a=e.done,i=e.value;return a?(n=[r[5],r[0],r[45]],r[59]=n[0],r[60]=n[1],r[61]=n[2],n):(t=i.item,o=[t.primarySortKey,t.secondarySortKey,t.localDataId],r[59]=o[0],r[60]=o[1],r[61]=o[2])})},function(e){return t.forEach(t.filter(t.db.table(12).fetch([[[r[4]]],"optimistic"]),function(e){return e.offlineThreadingId===r[4]&&t.i64.lt(e.authorityLevel,t.i64.cast([0,20]))}),function(e){return e.delete()})},function(n){return t.db.table(12).add({threadKey:e[1],messageId:r[4],timestampMs:r[0],offlineThreadingId:r[4],primarySortKey:r[59],secondarySortKey:r[60],text:r[58],senderId:e[0],stickerId:r[37],hotEmojiSize:r[39],platformXmdEncoded:r[41],isForwarded:r[42],forwardScore:r[43],isAdminMessage:!1,sendStatus:t.i64.cast([0,1]),sendStatusV2:t.i64.cast([0,1]),authorityLevel:t.i64.cast([0,20]),localDataId:r[61],replyType:r[26],ephemeralDurationInSec:r[48],subthreadParentMessageId:r[49],isExclusiveToSubthread:r[50],metadataDataclass:e[6],messageRenderingType:r[53],replySourceId:r[11],replySourceType:r[12],replySourceTypeV2:r[55],replyStatus:r[14],replySnippet:r[15],replyToUserId:r[16],replyMessageText:r[17],replyAttachmentId:r[18],replyAttachmentType:r[19],replyMediaUrl:r[20],replyMediaUrlFallback:r[21],replyMediaPreviewWidth:r[22],replyMediaPreviewHeight:r[23],replyMediaUrlMimeType:r[24],mentionOffsets:r[29],mentionLengths:r[30],mentionIds:r[31],mentionTypes:r[32],transportKey:r[57]})}])}])},function(o){return r[5]=t.createArray(),r[6]=(r[5].push("LSMailboxLocalApplyOptimisticMessageV2StoredProcedure"),r[5]),r[7]=(r[5].push("localApplyOptimisticMessage"),r[5]),r[8]=(r[5].push(e[1]),r[5]),r[9]=(r[5].push(r[4]),r[5]),r[10]=t.toJSON(r[5]),(function(e){t.logger(e).info(e)})(r[10]),r[2]=e[5].get("calculate_denormalizations"),r[2]==null||r[2]?t.sequence([function(o){return t.storedProcedure(n("LSSetMessageViewFlags"),e[1],r[4],r[0],t.i64.eq(e[2],t.i64.cast([0,1])))},function(o){return r[5]=e[5].get("sticker_id"),t.storedProcedure(n("LSSetMessageDisplayedContentTypes"),e[1],r[4],r[0],e[3],!1,t.i64.neq(r[5],void 0))}]):t.resolve()},function(e){var t;return t=[r[4],r[0]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxLocalApplyOptimisticMessageV2StoredProcedure",e.__tables__=["threads","contacts","participants","user_visible_network_connectivity_error","messages","attachments"],a.exports=e}),null);
__d("LSMarkSubJobCompletedV2",["LSArrayGetObjectAt"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(n){return r[0]=t.createArray(),t.db.table(51).fetch([[[e[0]]]]).next().then(function(e,n){var o=e.done,a=e.value;return o?0:(n=a.item,r[3]=new t.Map,r[3].set("offline_attachment_id",n.offlineAttachmentId),r[3].set("offline_threading_id",n.offlineThreadingId),r[3].set("in_message_index",n.inMessageIndex),r[3].set("attachment_type",n.attachmentType),r[3].set("should_transcode",n.shouldTranscode),r[3].set("use_double_phase",n.useDoublePhase),r[3].set("send_by_server",n.sendByServer),r[3].set("is_secure",n.isSecure),r[3].set("state",n.state),r[3].set("fbid",n.fbid),r[3].set("metadata",n.metadata),r[3].set("error",n.error),r[3].set("message_id",n.messageId),r[4]=(r[0].push(r[3]),r[0]))})},function(o){return r[2]=t.i64.of_int32(r[0].length),t.i64.neq(r[2],t.i64.cast([0,0]))?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[0],t.i64.cast([0,0])).then(function(e){var t;return t=e,r[3]=t[0],r[4]=t[1],t})},function(n){return r[5]=r[3].get("state"),t.i64.neq(e[1],void 0)?e[2]!==void 0?(t.i64.eq(r[5],t.i64.cast([-1,4294967293]))?(r[7]=t.i64.cast([-1,4294967295]),r[6]=r[7]):(t.i64.eq(r[5],t.i64.cast([0,1]))?r[7]=t.i64.cast([0,2]):(t.i64.eq(r[5],t.i64.cast([0,3]))?r[8]=t.i64.cast([0,4]):(t.i64.eq(r[5],t.i64.cast([0,5]))?r[9]=t.i64.cast([0,6]):(t.i64.eq(r[5],t.i64.cast([0,13]))?r[10]=t.i64.cast([0,14]):(t.i64.eq(r[5],t.i64.cast([0,7]))?r[11]=t.i64.cast([0,8]):(t.i64.eq(r[5],t.i64.cast([0,9]))?r[12]=t.i64.cast([0,10]):(t.i64.eq(r[5],t.i64.cast([0,11]))?r[13]=t.i64.cast([0,12]):r[13]=r[5],r[12]=r[13]),r[11]=r[12]),r[10]=r[11]),r[9]=r[10]),r[8]=r[9]),r[7]=r[8]),r[6]=r[7]),t.forEach(t.db.table(51).fetch([[[e[0]]]]),function(t){var n=t.update,o=t.item;return n({state:r[6],fbid:e[1],messageId:e[2],metadata:e[3]})})):(t.i64.eq(r[5],t.i64.cast([-1,4294967293]))?(r[7]=t.i64.cast([-1,4294967295]),r[6]=r[7]):(t.i64.eq(r[5],t.i64.cast([0,1]))?r[7]=t.i64.cast([0,2]):(t.i64.eq(r[5],t.i64.cast([0,3]))?r[8]=t.i64.cast([0,4]):(t.i64.eq(r[5],t.i64.cast([0,5]))?r[9]=t.i64.cast([0,6]):(t.i64.eq(r[5],t.i64.cast([0,13]))?r[10]=t.i64.cast([0,14]):(t.i64.eq(r[5],t.i64.cast([0,7]))?r[11]=t.i64.cast([0,8]):(t.i64.eq(r[5],t.i64.cast([0,9]))?r[12]=t.i64.cast([0,10]):(t.i64.eq(r[5],t.i64.cast([0,11]))?r[13]=t.i64.cast([0,12]):r[13]=r[5],r[12]=r[13]),r[11]=r[12]),r[10]=r[11]),r[9]=r[10]),r[8]=r[9]),r[7]=r[8]),r[6]=r[7]),t.forEach(t.db.table(51).fetch([[[e[0]]]]),function(t){var n=t.update,o=t.item;return n({state:r[6],fbid:e[1],metadata:e[3]})})):t.i64.neq(e[4],void 0)?(t.i64.eq(r[5],t.i64.cast([-1,4294967293]))?(r[7]=t.i64.cast([-1,4294967295]),r[6]=r[7]):(t.i64.eq(r[5],t.i64.cast([0,1]))?r[7]=t.i64.cast([0,2]):(t.i64.eq(r[5],t.i64.cast([0,3]))?r[8]=t.i64.cast([0,4]):(t.i64.eq(r[5],t.i64.cast([0,5]))?r[9]=t.i64.cast([0,6]):(t.i64.eq(r[5],t.i64.cast([0,13]))?r[10]=t.i64.cast([0,14]):(t.i64.eq(r[5],t.i64.cast([0,7]))?r[11]=t.i64.cast([0,8]):(t.i64.eq(r[5],t.i64.cast([0,9]))?r[12]=t.i64.cast([0,10]):(t.i64.eq(r[5],t.i64.cast([0,11]))?r[13]=t.i64.cast([0,12]):r[13]=r[5],r[12]=r[13]),r[11]=r[12]),r[10]=r[11]),r[9]=r[10]),r[8]=r[9]),r[7]=r[8]),r[6]=r[7]),t.forEach(t.db.table(51).fetch([[[e[0]]]]),function(t){var n=t.update,o=t.item;return n({state:r[6],error:e[4]})})):(t.i64.eq(r[5],t.i64.cast([-1,4294967293]))?(r[7]=t.i64.cast([-1,4294967295]),r[6]=r[7]):(t.i64.eq(r[5],t.i64.cast([0,1]))?r[7]=t.i64.cast([0,2]):(t.i64.eq(r[5],t.i64.cast([0,3]))?r[8]=t.i64.cast([0,4]):(t.i64.eq(r[5],t.i64.cast([0,5]))?r[9]=t.i64.cast([0,6]):(t.i64.eq(r[5],t.i64.cast([0,13]))?r[10]=t.i64.cast([0,14]):(t.i64.eq(r[5],t.i64.cast([0,7]))?r[11]=t.i64.cast([0,8]):(t.i64.eq(r[5],t.i64.cast([0,9]))?r[12]=t.i64.cast([0,10]):(t.i64.eq(r[5],t.i64.cast([0,11]))?r[13]=t.i64.cast([0,12]):r[13]=r[5],r[12]=r[13]),r[11]=r[12]),r[10]=r[11]),r[9]=r[10]),r[8]=r[9]),r[7]=r[8]),r[6]=r[7]),t.forEach(t.db.table(51).fetch([[[e[0]]]]),function(e){var t=e.update,n=e.item;return t({state:r[6]})}))}]):t.resolve()}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMediaSendMarkSubJobCompletedV2StoredProcedure",e.__tables__=["media_send_jobs"],a.exports=e}),null);
__d("LSMarkSubJobCompletedV2StoredProcedure",["LSMarkSubJobCompletedV2","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSMarkSubJobCompletedV2"),a.offlineAttachmentId,a.fbid,a.messageId,a.metadata,a.error);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSMarkThreadRead",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(n){return t.forEach(t.filter(t.db.table(9).fetch([[[e[1]]]]),function(n){return t.i64.eq(n.threadKey,e[1])&&t.i64.gt(e[0],n.lastReadWatermarkTimestampMs)}),function(t){var n=t.update,r=t.item;return n({lastReadWatermarkTimestampMs:e[0]})})},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxMarkThreadReadStoredProcedure",e.__tables__=["threads"],a.exports=e}),null);
__d("LSMediaUrlAttachment",["I64","LSMediaUrlUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){var t=e.previewUrlExpirationTimestampMs;return t!=null&&o("LSMediaUrlUtils").isTimestampExpired(t)?e.previewUrlFallback:e.previewUrl}function u(e){var t=e.previewUrlExpirationTimestampMs;return t!=null&&o("LSMediaUrlUtils").isTimestampExpired(t)?e.previewUrlFallback:e.previewUrlLarge}function c(e){var t=e.playableUrlExpirationTimestampMs;return t!=null&&o("LSMediaUrlUtils").isTimestampExpired(t)?e.playableUrlFallback:e.playableUrl}function d(e){var t=e.imageUrlExpirationTimestampMs;return t!=null&&o("LSMediaUrlUtils").isTimestampExpired(t)?e.imageUrlFallback:e.imageUrl}function m(e){var t=e.faviconUrlExpirationTimestampMs;return t!=null&&o("LSMediaUrlUtils").isTimestampExpired(t)?e.faviconUrlFallback:e.faviconUrl}function p(t){try{var n=t.listItemContactUrlExpirationTimestampList1;return n!=null&&o("LSMediaUrlUtils").isTimestampExpired((e||(e=o("I64"))).of_string(n))?t.listItemContactUrlFallbackList1:t.listItemContactUrlList1}catch(e){return t.listItemContactUrlList1}}function _(t){try{var n=t.listItemContactUrlExpirationTimestampList2;return n!=null&&o("LSMediaUrlUtils").isTimestampExpired((e||(e=o("I64"))).of_string(n))?t.listItemContactUrlFallbackList2:t.listItemContactUrlList2}catch(e){return t.listItemContactUrlList2}}function f(t){try{var n=t.listItemContactUrlExpirationTimestampList3;return n!=null&&o("LSMediaUrlUtils").isTimestampExpired((e||(e=o("I64"))).of_string(n))?t.listItemContactUrlFallbackList3:t.listItemContactUrlList3}catch(e){return t.listItemContactUrlList3}}function g(e){var t=e.headerImageUrlExpirationTimestampMs;return t!=null&&o("LSMediaUrlUtils").isTimestampExpired(t)?e.headerImageUrlFallback:e.headerImageUrl}function h(t){try{var n=t.listItemProfilePictureUrlExpirationTimestamp1;return n!=null&&o("LSMediaUrlUtils").isTimestampExpired((e||(e=o("I64"))).of_string(n))?t.listItemProfilePictureUrlFallback1:t.listItemProfilePictureUrl1}catch(e){return t.listItemProfilePictureUrl1}}function y(t){try{var n=t.listItemProfilePictureUrlExpirationTimestamp2;return n!=null&&o("LSMediaUrlUtils").isTimestampExpired((e||(e=o("I64"))).of_string(n))?t.listItemProfilePictureUrlFallback2:t.listItemProfilePictureUrl2}catch(e){return t.listItemProfilePictureUrl2}}function C(t){try{var n=t.listItemProfilePictureUrlExpirationTimestamp3;return n!=null&&o("LSMediaUrlUtils").isTimestampExpired((e||(e=o("I64"))).of_string(n))?t.listItemProfilePictureUrlFallback3:t.listItemProfilePictureUrl3}catch(e){return t.listItemProfilePictureUrl3}}l.previewUrl=s,l.previewUrlLarge=u,l.playableUrl=c,l.imageUrl=d,l.faviconUrl=m,l.listItemContactUrlList1=p,l.listItemContactUrlList2=_,l.listItemContactUrlList3=f,l.headerImageUrl=g,l.listItemProfilePictureUrl1=h,l.listItemProfilePictureUrl2=y,l.listItemProfilePictureUrl3=C}),98);
__d("LSMessageSendToSentQPLInteractionHelper.nop",["LSSynchronousPromise","QPLUserFlow","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,a){return a!=null&&r("QPLUserFlow").addPoint(r("qpl")._(25313175,"1551"),n,{instanceKey:parseInt(a,10)}),o("LSSynchronousPromise").makeSynchronousPromise()}e.__nop_name__="LSMessageSendToSentQPLInteractionHelper",l.default=e}),98);
__d("LSOptimisticMarkThreadReadV2",["LSIssueNewTask","LSMarkThreadRead"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(o){return t.sequence([function(r){return t.storedProcedure(n("LSMarkThreadRead"),e[1],e[0])},function(n){return t.db.table(9).fetch([[[e[0]]]]).next().then(function(e,n){var o=e.done,a=e.value;return o?r[0]=t.i64.cast([0,1]):(n=a.item,r[3]=n.syncGroup,t.i64.neq(r[3],void 0)?r[2]=r[3]:r[2]=t.i64.cast([0,1]),r[0]=r[2])})},function(o){return r[2]=new t.Map,r[2].set("thread_id",e[0]),r[2].set("last_read_watermark_ts",e[1]),r[2].set("sync_group",r[0]),r[3]=r[2].get("thread_id"),r[4]=t.toJSON(r[2]),t.storedProcedure(n("LSIssueNewTask"),t.i64.to_string(r[3]),t.i64.cast([0,21]),r[4],void 0,void 0,t.i64.cast([0,0]),t.i64.cast([0,0]),void 0,void 0,t.i64.cast([0,0]),t.i64.cast([0,0]))}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMailboxOptimisticMarkThreadReadV2StoredProcedure",e.__tables__=["threads"],a.exports=e}),null);
__d("LSUpdateOptimisticAttachmentPreview",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(n){return t.forEach(t.filter(t.db.table(16).fetch([[[e[0],e[1],e[2]]]]),function(n){return n.attachmentFbid===e[2]&&t.i64.eq(n.threadKey,e[0])&&n.messageId===e[1]&&t.i64.eq(n.authorityLevel,t.i64.cast([0,20]))}),function(t){var n=t.update,r=t.item;return n({playableUrl:e[3],playableUrlFallback:e[4],playableUrlExpirationTimestampMs:e[5],playableUrlMimeType:e[6],previewUrl:e[7],previewUrlFallback:e[8],previewUrlExpirationTimestampMs:e[9],previewUrlMimeType:e[10],previewWidth:e[11],previewHeight:e[12],imageUrl:void 0,imageUrlFallback:void 0,imageUrlExpirationTimestampMs:void 0,imageUrlMimeType:void 0,titleText:e[13]})})},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMailboxUpdateOptimisticAttachmentPreviewStoredProcedure",e.__tables__=["attachments"],a.exports=e}),null);
__d("LSOptimisticSendMessageV2",["LSAppendDataTraceAddon.nop","LSArrayGetObjectAt","LSDeserializeFromJsonIntoDictionaryV2.nop","LSInsertOptimisticAttachment","LSIssueNewTaskWithExtraOperationsAndGetTaskID","LSLocalApplyOptimisticMessageV2","LSLogEventAnnotate.nop","LSMessageSendToSentQPLInteractionHelper.nop","LSOptimisticMarkThreadReadV2","LSPredefineTraceForTask","LSUpdateOptimisticAttachmentPreview","gkx"],(function(t,n,r,o,a,i,l){function e(){var e=arguments,t=e[e.length-1],o=[],a=[];return t.sequence([function(i){return t.sequence([function(r){return o[0]=e[6].get("qpl_instance_key"),t.storedProcedure(n("LSLocalApplyOptimisticMessageV2"),e[0],e[1],e[2],e[4],e[5],e[6],e[8]).then(function(e){var t;return t=e,o[1]=t[0],o[2]=t[1],t})},function(a){return t.sequence([function(r){return o[5]=e[6].get("external_attachment_url"),o[44]=o[5]===""?void 0:o[5],o[44]!==void 0?t.sequence([function(r){return o[45]=e[6].get("attribution_app_id"),o[46]=e[6].get("optimistic_attachment_preview"),t.nativeOperation(n("LSMessageSendToSentQPLInteractionHelper.nop"),"sp_insert_optimistic_gif_start",o[0])},function(r){return t.storedProcedure(n("LSInsertOptimisticAttachment"),e[1],o[2],o[1],o[1],o[1],t.i64.cast([0,3]),o[44],t.i64.cast([0,0]),o[45],!0,!1)},function(r){return o[46]?o[47]=!1:o[47]=!0,o[47]?t.resolve():(o[48]=o[46].get("playable_url"),o[49]=o[46].get("playable_url_fallback"),o[50]=o[46].get("playable_url_expiration_timestamp_ms"),o[51]=o[46].get("playable_url_mime_type"),o[52]=o[46].get("preview_url"),o[53]=o[46].get("preview_url_fallback"),o[54]=o[46].get("preview_url_expiration_timestamp_ms"),o[55]=o[46].get("preview_url_mime_type"),o[56]=o[46].get("preview_width"),o[57]=o[46].get("preview_height"),o[58]=o[46].get("image_url"),o[59]=o[46].get("image_url_fallback"),o[60]=o[46].get("image_url_expiration_timestamp_ms"),o[61]=o[46].get("image_url_mime_type"),o[62]=o[46].get("title_text"),t.storedProcedure(n("LSUpdateOptimisticAttachmentPreview"),e[1],o[1],o[1],o[48],o[49],o[50],o[51],o[52],o[53],o[54],o[55],o[56],o[57],o[62]))},function(e){return t.nativeOperation(n("LSMessageSendToSentQPLInteractionHelper.nop"),"sp_insert_optimistic_gif_end",o[0])},function(e){return o[6]=t.i64.cast([0,7])}]):t.sequence([function(r){return o[45]=e[6].get("sticker_id"),t.i64.neq(o[45],void 0)?t.sequence([function(r){return t.i64.neq(o[45],t.i64.cast([53057,267535043]))&&t.i64.neq(o[45],t.i64.cast([85970,924785702]))&&t.i64.neq(o[45],t.i64.cast([85970,1004785694]))&&t.i64.neq(o[45],t.i64.cast([85970,1044785690]))?t.sequence([function(r){return o[49]=t.i64.to_string(o[45]),o[47]=e[6].get("optimistic_attachment_preview"),t.nativeOperation(n("LSMessageSendToSentQPLInteractionHelper.nop"),"sp_insert_optimistic_sticker_start",o[0])},function(r){return t.storedProcedure(n("LSInsertOptimisticAttachment"),e[1],o[2],o[1],t.i64.to_string(o[45]),o[49],t.i64.cast([0,1]),void 0,t.i64.cast([0,0]),void 0,!0,!1)},function(r){return o[47]?o[48]=!1:o[48]=!0,o[48]?t.resolve():(o[50]=o[47].get("playable_url"),o[51]=o[47].get("playable_url_fallback"),o[52]=o[47].get("playable_url_expiration_timestamp_ms"),o[53]=o[47].get("playable_url_mime_type"),o[54]=o[47].get("preview_url"),o[55]=o[47].get("preview_url_fallback"),o[56]=o[47].get("preview_url_expiration_timestamp_ms"),o[57]=o[47].get("preview_url_mime_type"),o[58]=o[47].get("preview_width"),o[59]=o[47].get("preview_height"),o[60]=o[47].get("image_url"),o[61]=o[47].get("image_url_fallback"),o[62]=o[47].get("image_url_expiration_timestamp_ms"),o[63]=o[47].get("image_url_mime_type"),o[64]=o[47].get("title_text"),t.storedProcedure(n("LSUpdateOptimisticAttachmentPreview"),e[1],o[1],o[49],o[50],o[51],o[52],o[53],o[54],o[55],o[56],o[57],o[58],o[59],o[64]))},function(e){return t.nativeOperation(n("LSMessageSendToSentQPLInteractionHelper.nop"),"sp_insert_optimistic_sticker_end",o[0])}]):t.resolve()},function(e){return o[46]=t.i64.cast([0,2])}]):t.sequence([function(r){return o[47]=e[6].get("signed_xma_dataclass"),o[47]!==void 0?t.sequence([function(r){return t.storedProcedure(n("LSInsertOptimisticAttachment"),e[1],o[2],o[1],o[1],o[1],t.i64.cast([0,7]),void 0,t.i64.cast([0,0]),void 0,!1,!0)},function(e){return o[48]=t.i64.cast([0,12])}]):t.sequence([function(r){return e[8]!==void 0?t.sequence([function(r){return t.nativeOperation(n("LSDeserializeFromJsonIntoDictionaryV2.nop"),e[8]).then(function(e){var t;return t=e,o[50]=t[0],t})},function(e){return o[51]=new t.Map,o[52]=o[50].keys(),o[53]=t.i64.of_int32(o[52].length),t.i64.gt(o[53],t.i64.cast([0,0]))?t.loopAsync(o[53],function(e){return o[58]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[52],o[58]).then(function(e){var t;return t=e,o[59]=t[0],o[60]=t[1],t})},function(e){return o[61]=o[50].get(o[59]),o[51].set(o[59],o[61])}])}):t.resolve()},function(e){return o[54]=o[51].get("xma_music_sticker_message_metadata"),o[54]?o[55]=!1:o[55]=!0,o[55]?t.resolve(o[56]=void 0):t.sequence([function(e){return o[58]=new t.Map,o[59]=o[54].keys(),o[60]=t.i64.of_int32(o[59].length),t.i64.gt(o[60],t.i64.cast([0,0]))?t.loopAsync(o[60],function(e){return o[61]=e,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),o[59],o[61]).then(function(e){var t;return t=e,o[62]=t[0],o[63]=t[1],t})},function(e){return o[64]=o[54].get(o[62]),o[58].set(o[62],o[64])}])}):t.resolve()},function(e){return o[56]=o[58]}])},function(r){return o[56]!==void 0?t.sequence([function(r){return o[58]=new t.Map,o[58].set("action_url",void 0),o[58].set("cta_type","XMA_MUSIC_ARTIST"),o[59]=o[56].get("song_id"),o[60]=o[56].get("song_title"),o[61]=o[56].get("song_subtitle"),o[62]=o[56].get("start_time"),o[62]!==void 0?o[63]=t.i64.from_string(o[62]):o[63]=void 0,o[64]=o[56].get("is_explicit"),o[65]=new t.Map,o[65].set("song_id",o[59]),o[65].set("song_title",o[60]),o[65].set("song_subtitle",o[61]),t.i64.neq(o[63],void 0)?o[66]=t.i64.to_string(o[63]):o[66]=void 0,o[65].set("start_time",o[66]),o[65].set("is_explicit",o[64]),o[65].set("derived_content_id",void 0),o[65].set("cta_artist",o[58]),o[65].set("preview",void 0),o[65].set("__typename","XMSGXmaMusicTemplateData"),o[67]=new t.Map,o[67].set("custom_template_data",o[65]),o[67].set("__typename","XMSGXmaSingleContent"),o[68]=new t.Map,o[68].set("content",o[67]),o[68].set("layout_type","SINGLE"),o[68].set("content_type",t.i64.cast([0,3046])),o[69]=t.toJSON(o[68]),o[70]=e[6].get("optimistic_attachment_preview"),t.storedProcedure(n("LSInsertOptimisticAttachment"),e[1],o[2],o[1],o[1],o[1],t.i64.cast([0,7]),void 0,t.i64.cast([0,0]),void 0,!1,!0)},function(r){return o[70]?o[71]=!1:o[71]=!0,o[71]?t.resolve():(o[72]=o[70].get("playable_url"),o[73]=o[70].get("playable_url_fallback"),o[74]=o[70].get("playable_url_expiration_timestamp_ms"),o[75]=o[70].get("playable_url_mime_type"),o[76]=o[70].get("preview_url"),o[77]=o[70].get("preview_url_fallback"),o[78]=o[70].get("preview_url_expiration_timestamp_ms"),o[79]=o[70].get("preview_url_mime_type"),o[80]=o[70].get("preview_width"),o[81]=o[70].get("preview_height"),o[82]=o[70].get("image_url"),o[83]=o[70].get("image_url_fallback"),o[84]=o[70].get("image_url_expiration_timestamp_ms"),o[85]=o[70].get("image_url_mime_type"),o[86]=o[70].get("title_text"),t.storedProcedure(n("LSUpdateOptimisticAttachmentPreview"),e[1],o[1],o[1],o[72],o[73],o[74],o[75],o[76],o[77],o[78],o[79],o[80],o[81],o[86]))},function(e){return o[57]=t.i64.cast([0,2])}]):t.resolve(o[57]=t.i64.cast([0,1]))},function(e){return o[49]=o[57]}]):t.resolve(o[49]=t.i64.cast([0,1]))},function(e){return o[48]=o[49]}])},function(e){return o[46]=o[48]}])},function(e){return o[6]=o[46]}])},function(e){return t.nativeOperation(n("LSMessageSendToSentQPLInteractionHelper.nop"),"sp_send_message_v2_task_start",o[0])},function(n){return o[7]=t.i64.cast([0,0]),t.db.table(9).fetch([[[e[1]]]]).next().then(function(e,n){var r=e.done,a=e.value;return r?o[8]=t.i64.cast([0,1]):(n=a.item,o[46]=n.syncGroup,t.i64.neq(o[46],void 0)?o[45]=o[46]:o[45]=t.i64.cast([0,1]),o[8]=o[45])})},function(r){return o[10]=e[6].get("plugin_type"),t.storedProcedure(n("LSIssueNewTaskWithExtraOperationsAndGetTaskID"),t.i64.to_string(e[1]),t.i64.cast([0,46]),"",void 0,void 0,o[10]==null?t.i64.cast([0,0]):o[10],t.i64.cast([0,0]),o[8],void 0,t.i64.cast([0,0]),void 0,o[7]==null?t.i64.cast([0,0]):o[7]).then(function(e){var t;return t=e,o[11]=t[0],t})},function(e){return t.nativeOperation(n("LSMessageSendToSentQPLInteractionHelper.nop"),"sp_send_message_v2_task_end",o[0])},function(r){return o[12]=e[6].get("data_trace_id"),o[12]!==void 0?t.sequence([function(e){return t.storedProcedure(n("LSPredefineTraceForTask"),o[12],o[11],t.i64.to_string(t.i64.cast([0,46])),o[1])},function(r){return o[45]=e[6].get("source"),o[48]=t.i64.to_string(o[45]),o[48]!==void 0?o[46]=o[48]:o[46]=t.i64.to_string(t.i64.cast([0,0])),o[47]=",",t.nativeOperation(n("LSAppendDataTraceAddon.nop"),o[12],t.i64.cast([0,20]),t.i64.cast([0,1]),void 0,[o[46],o[47],t.i64.to_string(o[6]),o[47],t.i64.to_string(e[2])].join(""))}]):t.resolve()},function(n){return o[13]=e[6].get("blocked_by_otids"),o[14]=new t.Map,o[15]=e[6].get("openEb"),o[16]=e[6].get("source"),o[17]=e[6].get("external_attachment_url"),o[18]=e[6].get("platform_ref"),o[19]=e[6].get("platform_token"),o[20]=e[6].get("reply_source_id"),o[21]=e[6].get("reply_source_attachment_id"),o[22]=e[6].get("reply_source_type"),o[23]=e[6].get("mark_read"),o[24]=e[6].get("initiating_app_id"),o[25]=e[6].get("initiating_source"),o[26]=e[6].get("navigation_chain"),o[27]=e[6].get("dety_params"),o[28]=e[6].get("skip_url_preview_gen"),o[29]=e[6].get("text_has_links"),o[30]=e[6].get("multitab_env"),o[31]=e[6].get("subthread_parent_message_id"),o[32]=e[6].get("is_exclusive_to_subthread"),o[33]=e[6].get("rich_text_format_type"),o[34]=e[6].get("plugin_type"),t.i64.eq(o[34],t.i64.cast([0,40]))?o[35]="Instamadillo":o[35]="FBBroker",o[36]=e[6].get("signed_xma_dataclass"),o[37]=e[6].get("signed_xma_dataclass_validation"),t.db.table(31).add({taskId:o[11],threadKey:e[1],openEb:o[15],qplInstanceKey:o[0],offlineThreadingId:o[1],threadAttributionSource:o[16],externalAttachmentUrl:o[17],platformRef:o[18],platformToken:o[19],replySourceId:o[20],replySourceType:o[22],sendType:o[6],markThreadRead:o[23]==null?!1:o[23],initiatingSource:o[25],skipUrlPreviewGen:o[28],textHasLinks:o[29],dataclassParams:e[7],multitabEnv:o[30],subthreadParentMessageId:o[31],isExclusiveToSubthread:o[32],metadataDataclass:e[8],richTextFormatType:o[33],transportKey:o[35]})},function(a){return r("gkx")("834")&&t.i64.eq(e[2],t.i64.cast([0,1]))?t.resolve(0):(o[45]=e[6].get("mark_read"),o[45]!=null&&o[45]?t.sequence([function(e){return t.nativeOperation(n("LSMessageSendToSentQPLInteractionHelper.nop"),"sp_mark_thread_read_start",o[0])},function(r){return t.storedProcedure(n("LSOptimisticMarkThreadReadV2"),e[1],o[2])},function(e){return t.nativeOperation(n("LSMessageSendToSentQPLInteractionHelper.nop"),"sp_mark_thread_read_end",o[0])}]):t.resolve())},function(r){return o[38]=t.createArray(),o[39]=(o[38].push("optimisticSendMessageV2"),o[38]),o[40]=(o[38].push(e[1]),o[38]),o[41]=(o[38].push(o[1]),o[38]),o[42]=t.toJSON(o[38]),(function(e){t.logger(e).info(e)})(o[42]),o[43]=new t.Map,o[43].set("offline_threading_id",o[1]),o[43].set("task_id",o[11]),o[43].set("task_queue_name",t.i64.to_string(e[1])),o[43].set("task_label",t.i64.to_string(t.i64.cast([0,46]))),t.nativeOperation(n("LSLogEventAnnotate.nop"),t.i64.cast([0,16]),t.i64.cast([0,23]),t.i64.cast([0,0]),o[43])},function(e){var t;return t=[o[1],o[11]],o[3]=t[0],o[4]=t[1],t}])},function(e){return a[0]=o[3]}])},function(e){return t.resolve(a)}])}e.__sproc_name__="LSMailboxOptimisticSendMessageV2StoredProcedure",e.__tables__=["threads","messages_optimistic_context"];var s=e;l.default=s}),98);
__d("LSOptimisticSendMessageV2StoredProcedure",["LSOptimisticSendMessageV2","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSOptimisticSendMessageV2"),a.senderId,a.threadKey,a.threadType,a.mailboxType,a.text,a.snippet,a.extraSendMessageParams,a.dataclassParams,a.metadataDataclass);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSRemoveMediaSendJobs",[],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],n=[],r=[];return t.sequence([function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){return e.delete()})},function(e){return t.resolve(r)}])}e.__sproc_name__="LSMediaSendRemoveMediaSendJobsStoredProcedure",e.__tables__=["media_send_jobs"],a.exports=e}),null);
__d("LSRemoveMediaSendJobsStoredProcedure",["LSRemoveMediaSendJobs","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSRemoveMediaSendJobs"),a.offlineThreadingId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSSendPhase1MultiPhotoMessageV2",["LSArrayGetObjectAt","LSGetMessageAttributionParams","LSIssueSendAttachmentMessageTask"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.createArray(),r[1]=new t.Map,r[2]=new t.Map,r[3]=!1,r[4]=t.i64.cast([0,0]),t.forEach(t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["inMessageIndex","ASC"]]),function(e){var n=e.item;return r[7]=n.fbid,r[4]=t.i64.add(r[4],t.i64.cast([0,1])),t.i64.neq(r[7],void 0)?r[8]=(r[0].push(r[7]),r[0]):0})},function(o){return r[5]=t.i64.of_int32(r[0].length),t.i64.neq(r[5],r[4])||t.i64.eq(r[4],t.i64.cast([0,0]))?t.resolve(r[6]=t.i64.cast([0,10002])):t.sequence([function(n){return t.db.table(12).fetch([[[e[0]]],"optimistic"]).next().then(function(e,t){var n,o,a=e.done,i=e.value;return a?(n=[void 0,void 0,void 0,void 0,void 0],r[7]=n[0],r[8]=n[1],r[9]=n[2],r[10]=n[3],r[11]=n[4],n):(t=i.item,o=[t.threadKey,t.senderId,t.text,t.replySourceId,t.replySourceTypeV2],r[7]=o[0],r[8]=o[1],r[9]=o[2],r[10]=o[3],r[11]=o[4])})},function(o){return t.i64.eq(r[7],void 0)||t.i64.eq(r[8],void 0)?t.resolve((t.i64.eq(r[7],void 0)?r[14]=t.i64.cast([0,10003]):r[14]=t.i64.cast([0,10004]),r[13]=r[14])):t.sequence([function(e){return t.db.table(9).fetch([[[r[7]]]]).next().then(function(e,t){var n=e.done,o=e.value;return n?r[14]=void 0:(t=o.item,r[14]=t.threadType)})},function(n){return t.filter(t.db.table(31).fetch(),function(t){return t.offlineThreadingId===e[0]}).next().then(function(e,t){var n,o,a=e.done,i=e.value;return a?(n=[void 0,void 0,void 0,void 0,void 0,void 0,void 0],r[16]=n[0],r[17]=n[1],r[18]=n[2],r[19]=n[3],r[20]=n[4],r[21]=n[5],r[22]=n[6],n):(t=i.item,o=[t.platformRef,t.platformToken,t.initiatingSource,void 0,void 0,t.dataclassParams,t.metadataDataclass],r[16]=o[0],r[17]=o[1],r[18]=o[2],r[19]=o[3],r[20]=o[4],r[21]=o[5],r[22]=o[6])})},function(o){return t.i64.neq(r[14],void 0)?t.sequence([function(o){return r[25]=r[1].keys(),r[26]=t.i64.of_int32(r[25].length),t.i64.gt(r[26],t.i64.cast([0,0]))?t.loopAsync(r[26],function(o){return r[32]=o,t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[25],r[32]).then(function(e){var t;return t=e,r[33]=t[0],r[34]=t[1],t})},function(o){return r[35]=r[2].get(r[33]),r[36]=t.i64.to_string(r[35]),r[36]!==void 0?t.sequence([function(e){return t.nativeTypeOperation("Array",n("LSArrayGetObjectAt"),r[25],r[32]).then(function(e){var t;return t=e,r[37]=t[0],r[38]=t[1],t})},function(n){return r[39]=r[1].get(r[33]),t.forEach(t.filter(t.db.table(16).fetch([[[r[7],e[0],r[37]]]]),function(n){return t.i64.eq(n.threadKey,r[7])&&t.i64.eq(t.i64.cast([0,0]),t.i64.cast([0,0]))&&n.messageId===e[0]&&n.attachmentFbid===r[37]}),function(e){var t=e.update,n=e.item;return t({attachmentFbid:r[36],originalFileHash:r[39]})})}]):t.resolve()}])}):t.resolve()},function(o){return t.storedProcedure(n("LSGetMessageAttributionParams"),e[0]).then(function(e){var t;return t=e,r[27]=t[0],r[28]=t[1],r[29]=t[2],t})},function(o){return t.i64.neq(r[27],void 0)?r[30]=r[27]:r[30]=t.i64.cast([0,0]),t.storedProcedure(n("LSIssueSendAttachmentMessageTask"),r[8],r[7],r[14],e[0],r[9],r[0],r[30],r[10],r[11],r[3],r[16],r[17],e[1],r[22])},function(e){return t.i64.ge(t.i64.cast([0,0]),t.i64.cast([0,0]))?r[31]=void 0:r[31]=t.i64.cast([0,10006]),r[24]=r[31]}]):t.resolve(r[24]=t.i64.cast([0,10005]))},function(e){return r[13]=r[24]}])},function(e){return r[6]=r[13]}])},function(e){return o[0]=r[6]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMediaSendSendPhase1MultiPhotoMessageV2StoredProcedure",e.__tables__=["media_send_jobs","messages","threads","messages_optimistic_context","attachments"],a.exports=e}),null);
__d("LSResumeMediaSendJob",["LSInsertPhase2PendingTask","LSSendPhase1MultiPhotoMessageV2"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=new t.Map,r[1]=new t.Map,r[1].set("main_job_succeeded",!1),r[1].set("resume_failed",!1),r[1].set("error",void 0),r[1].set("running_sub_job_states",r[0]),r[2]=new t.Map,r[2].set("should_transcode",!1),r[2].set("use_double_phase",!1),r[2].set("send_by_server",!1),r[2].set("is_secure",!1),r[2].set("should_dedupe",!1),r[2].set("is_optimistic_upload",!1),t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["state","ASC"]]).next().then(function(e,t){var n=e.done,o=e.value;return n?0:(t=o.item,r[2].set("should_transcode",t.shouldTranscode),r[2].set("use_double_phase",t.useDoublePhase),r[2].set("send_by_server",t.sendByServer),r[2].set("is_secure",t.isSecure),r[2].set("is_optimistic_upload",!1))})},function(n){return r[4]=new t.Map,t.forEach(t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["inMessageIndex","ASC"]]),function(e){var n=e.item;return r[13]=n.offlineAttachmentId,r[11]=n.state,r[12]=n.error,t.i64.eq(r[11],t.i64.cast([-1,4294967293]))?r[10]=!0:(t.i64.eq(r[11],t.i64.cast([0,1]))?r[14]=!0:(t.i64.eq(r[11],t.i64.cast([0,3]))?r[15]=!0:(t.i64.eq(r[11],t.i64.cast([0,5]))?r[16]=!0:(t.i64.eq(r[11],t.i64.cast([0,13]))?r[17]=!0:(t.i64.eq(r[11],t.i64.cast([0,7]))?r[18]=!0:(t.i64.eq(r[11],t.i64.cast([0,9]))?r[19]=!0:(t.i64.eq(r[11],t.i64.cast([0,11]))?r[20]=!0:r[20]=!1,r[19]=r[20]),r[18]=r[19]),r[17]=r[18]),r[16]=r[17]),r[15]=r[16]),r[14]=r[15]),r[10]=r[14]),r[10]?t.resolve(t.i64.eq(r[11],t.i64.cast([0,5]))||t.i64.eq(r[11],t.i64.cast([0,11]))?0:r[4].set(r[13],r[11])):t.i64.neq(r[12],void 0)?t.resolve((r[1].set("resume_failed",!0),r[1].set("error",r[12]))):(t.i64.eq(r[11],t.i64.cast([-1,4294967295]))?r[14]=t.i64.cast([0,5]):(t.i64.eq(r[11],t.i64.cast([-1,4294967294]))?(r[16]=r[2].get("should_transcode"),r[15]=r[16]?t.i64.cast([0,1]):t.i64.cast([0,3])):(t.i64.eq(r[11],t.i64.cast([0,2]))?r[16]=t.i64.cast([0,3]):(t.i64.eq(r[11],t.i64.cast([0,4]))?(r[18]=r[2].get("send_by_server"),r[19]=r[2].get("use_double_phase"),r[17]=r[18]?r[19]?t.i64.cast([0,13]):void 0:t.i64.cast([0,5])):(t.i64.eq(r[11],t.i64.cast([0,6]))?(r[19]=r[2].get("use_double_phase"),r[18]=r[19]?t.i64.cast([0,13]):void 0):(t.i64.eq(r[11],t.i64.cast([0,14]))?(r[20]=r[2].get("use_double_phase"),r[21]=r[2].get("should_transcode"),r[19]=r[20]?r[21]?t.i64.cast([0,7]):t.i64.cast([0,9]):void 0):(t.i64.eq(r[11],t.i64.cast([0,8]))?r[20]=t.i64.cast([0,9]):(t.i64.eq(r[11],t.i64.cast([0,10]))?(r[22]=r[2].get("send_by_server"),r[21]=r[22]?void 0:t.i64.cast([0,11])):(t.i64.eq(r[11],t.i64.cast([0,12])),r[22]=void 0,r[21]=r[22]),r[20]=r[21]),r[19]=r[20]),r[18]=r[19]),r[17]=r[18]),r[16]=r[17]),r[15]=r[16]),r[14]=r[15]),t.i64.neq(r[14],void 0)?t.sequence([function(e){return t.forEach(t.db.table(51).fetch([[[r[13]]]]),function(e){var t=e.update,n=e.item;return t({state:r[14]})})},function(e){return t.i64.eq(r[14],t.i64.cast([0,5]))||t.i64.eq(r[14],t.i64.cast([0,11]))?0:r[4].set(r[13],r[14])}]):t.resolve())})},function(n){return t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["state","ASC"]]).next().then(function(e,t){var n=e.done,o=e.value;return n?r[5]=void 0:(t=o.item,r[5]=t.state)})},function(o){return t.i64.neq(r[5],void 0)?(r[10]=r[2].get("send_by_server"),r[11]=r[2].get("use_double_phase"),r[12]=r[2].get("use_double_phase"),(r[10]?r[11]?t.i64.eq(r[5],t.i64.cast([0,10])):t.i64.eq(r[5],t.i64.cast([0,4])):r[12]?t.i64.eq(r[5],t.i64.cast([0,12])):t.i64.eq(r[5],t.i64.cast([0,6])))?t.resolve(r[1].set("main_job_succeeded",!0)):t.i64.eq(r[5],t.i64.cast([0,5]))?t.sequence([function(n){return r[13]=void 0,t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var n=e.item;return r[15]=n.error,t.i64.eq(r[15],void 0)?(t.i64.neq(n.fbid,void 0)?r[16]=void 0:r[16]=t.i64.cast([0,9]),r[14]=r[16]):r[14]=r[15],t.i64.neq(r[14],void 0)?r[13]=r[14]:0})},function(o){return t.i64.neq(r[13],void 0)?t.resolve((r[1].set("resume_failed",!0),r[1].set("error",r[13]))):(r[14]=r[2].get("is_optimistic_upload"),r[14]?(r[15]=r[2].get("send_by_server"),r[16]=r[2].get("use_double_phase"),r[17]=r[2].get("use_double_phase"),(r[15]?r[16]?t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,10])):t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,4])):r[17]?t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,12])):t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,6])))?t.resolve(r[1].set("main_job_succeeded",!0)):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([-1,4294967295]))?r[18]=t.i64.cast([0,5]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([-1,4294967294]))?(r[20]=r[2].get("should_transcode"),r[19]=r[20]?t.i64.cast([0,1]):t.i64.cast([0,3])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,2]))?r[20]=t.i64.cast([0,3]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,4]))?(r[22]=r[2].get("send_by_server"),r[23]=r[2].get("use_double_phase"),r[21]=r[22]?r[23]?t.i64.cast([0,13]):void 0:t.i64.cast([0,5])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,6]))?(r[23]=r[2].get("use_double_phase"),r[22]=r[23]?t.i64.cast([0,13]):void 0):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,14]))?(r[24]=r[2].get("use_double_phase"),r[25]=r[2].get("should_transcode"),r[23]=r[24]?r[25]?t.i64.cast([0,7]):t.i64.cast([0,9]):void 0):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,8]))?r[24]=t.i64.cast([0,9]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,10]))?(r[26]=r[2].get("send_by_server"),r[25]=r[26]?void 0:t.i64.cast([0,11])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,12])),r[26]=void 0,r[25]=r[26]),r[24]=r[25]),r[23]=r[24]),r[22]=r[23]),r[21]=r[22]),r[20]=r[21]),r[19]=r[20]),r[18]=r[19]),t.i64.neq(r[18],void 0)?t.sequence([function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.update,n=e.item;return t({state:r[18]})})},function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.item;return r[4].set(t.offlineAttachmentId,t.state)})}]):t.resolve())):t.sequence([function(o){return r[15]=r[2].get("is_secure"),r[15]?t.sequence([function(n){return r[17]=t.createArray(),r[18]=new t.Map,r[19]=new t.Map,r[20]=!1,r[21]=t.i64.cast([0,0]),t.forEach(t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["inMessageIndex","ASC"]]),function(e){var n=e.item;return r[26]=n.fbid,r[21]=t.i64.add(r[21],t.i64.cast([0,1])),t.i64.neq(r[26],void 0)?r[27]=(r[17].push(r[26]),r[17]):0})},function(n){return r[22]=t.createArray(),t.forEach(t.sortBy(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),[["inMessageIndex","ASC"]]),function(e){var t=e.item;return r[26]=t.metadata,r[26]!==void 0?r[27]=(r[22].push(r[26]),r[22]):0})},function(e){return r[23]=t.i64.of_int32(r[17].length),r[24]=t.i64.of_int32(r[22].length),t.i64.neq(r[23],r[21])||t.i64.neq(r[24],r[21])?r[25]=t.i64.cast([0,11]):((function(e){t.logger(e).debug(e)})("[TincanLS][LSSecureMailboxSendSecureMediaMessageStoredProcedure] Started"),(function(e){t.logger(e).debug(e)})("[TincanLS][LSSecureMailboxSendSecureMediaMessageStoredProcedure] Completed"),r[25]=void 0),r[16]=r[25]}]):t.sequence([function(o){return t.storedProcedure(n("LSSendPhase1MultiPhotoMessageV2"),e[0],e[2]).then(function(e){var t;return t=e,r[17]=t[0],t})},function(n){return t.i64.eq(r[17],void 0)?t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var n=e.update,r=e.item;return n({state:t.i64.cast([0,6])})}):t.resolve()},function(e){return r[16]=r[17]}])},function(n){return t.i64.eq(r[16],void 0)?(r[17]=r[2].get("send_by_server"),r[18]=r[2].get("use_double_phase"),r[19]=r[2].get("use_double_phase"),(r[17]?r[18]?t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,10])):t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,4])):r[19]?t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,12])):t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,6])))?t.resolve(r[1].set("main_job_succeeded",!0)):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([-1,4294967295]))?r[20]=t.i64.cast([0,5]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([-1,4294967294]))?(r[22]=r[2].get("should_transcode"),r[21]=r[22]?t.i64.cast([0,1]):t.i64.cast([0,3])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,2]))?r[22]=t.i64.cast([0,3]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,4]))?(r[24]=r[2].get("send_by_server"),r[25]=r[2].get("use_double_phase"),r[23]=r[24]?r[25]?t.i64.cast([0,13]):void 0:t.i64.cast([0,5])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,6]))?(r[25]=r[2].get("use_double_phase"),r[24]=r[25]?t.i64.cast([0,13]):void 0):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,14]))?(r[26]=r[2].get("use_double_phase"),r[27]=r[2].get("should_transcode"),r[25]=r[26]?r[27]?t.i64.cast([0,7]):t.i64.cast([0,9]):void 0):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,8]))?r[26]=t.i64.cast([0,9]):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,10]))?(r[28]=r[2].get("send_by_server"),r[27]=r[28]?void 0:t.i64.cast([0,11])):(t.i64.eq(t.i64.cast([0,6]),t.i64.cast([0,12])),r[28]=void 0,r[27]=r[28]),r[26]=r[27]),r[25]=r[26]),r[24]=r[25]),r[23]=r[24]),r[22]=r[23]),r[21]=r[22]),r[20]=r[21]),t.i64.neq(r[20],void 0)?t.sequence([function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.update,n=e.item;return t({state:r[20]})})},function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.item;return r[4].set(t.offlineAttachmentId,t.state)})}]):t.resolve())):t.resolve((r[1].set("resume_failed",!0),r[1].set("error",r[16])))}]))}]):t.i64.eq(r[5],t.i64.cast([0,11]))?t.sequence([function(n){return r[13]=void 0,t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var n=e.item;return r[14]=n.error,t.i64.neq(r[14],void 0)?r[13]=r[14]:0})},function(e){return t.i64.neq(r[13],void 0)?(r[1].set("resume_failed",!0),r[1].set("error",r[13])):r[1].set("main_job_succeeded",!0)}]):t.i64.eq(r[5],t.i64.cast([0,13]))?t.sequence([function(o){return t.storedProcedure(n("LSInsertPhase2PendingTask"),e[0],e[1]).then(function(e){var t;return t=e,r[13]=t[0],t})},function(n){return t.i64.neq(r[13],void 0)?t.resolve((r[1].set("resume_failed",!0),r[1].set("error",r[13]))):t.sequence([function(n){return t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var n=e.update,r=e.item;return n({state:t.i64.cast([0,14])})})},function(n){return r[1].set("main_job_succeeded",!0),t.forEach(t.filter(t.db.table(51).fetch(),function(t){return t.offlineThreadingId===e[0]}),function(e){var t=e.item;return r[4].set(t.offlineAttachmentId,t.state)})}])}]):t.resolve(0)):t.resolve((r[1].set("resume_failed",!0),r[1].set("error",t.i64.cast([0,11]))))},function(e){var t;return r[7]=r[1].get("main_job_succeeded"),r[8]=r[1].get("resume_failed"),r[9]=r[1].get("error"),t=[r[7],r[8],r[9],r[4]],o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=t[3]}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMediaSendResumeMediaSendJobStoredProcedure",e.__tables__=["media_send_jobs"],a.exports=e}),null);
__d("LSResumeMediaSendJobStoredProcedure",["LSResumeMediaSendJob","LSSynchronousPromise","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSResumeMediaSendJob"),a.jobId,a.pluginType,a.dataTraceId);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MAWCreateOneToOneThread",["FBLogger","I64","LSAuthorityLevel","LSFactory","LSIntEnum","MAWBridgeSendAndReceive","MAWHandleActThread","MAWJids","MAWMiActMappingTableAPI","MAWThreadLoadingState","MAWThreadMappingQPL","MAWVerifyThreadExistsUtils","Promise","QPLUserFlow","WMIWABridgeApi","asyncToGeneratorRuntime","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=["instanceKey"],s,u,c;function d(e,t,n,r){if(t!=null)return t;var a=n!=null?(u||(u=o("I64"))).of_string(n):void 0,i=o("MAWThreadMappingQPL").getInstanceKeyForThreadKey(a!=null?a:(u||(u=o("I64"))).zero);return o("MAWThreadMappingQPL").start({instanceKey:i,jid:e,threadKey:a,trigger:"MAWCreateOneToOneThread_"+r}),i}function m(e,t,n){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=yield o("MAWVerifyThreadExistsUtils").runVerifyThreadExistsSproc(r("LSFactory")(e),{authorityLevel:(c||(c=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").OPTIMISTIC),threadType:c.ofNumber(15)},"MAWCreateOneToOneThread"),i=a[0];if(r("gkx")("17734")){var l=yield e.threads.get(i);l==null?r("FBLogger")("maw_one_to_one_thread_creation").mustfix("No thread written to threads table"):yield e.threads.upsert([i],babelHelpers.extends({},l,{clientThreadKey:i}))}var s=yield R(e,t);return s===!0&&(o("MAWThreadMappingQPL").addPoint("insert_placeholder_mapping_row",n),yield o("MAWThreadLoadingState").markActThreadLoadingAsInProgress(e,i,o("MAWJids").convertChatJidToIntJid(t))),(u||(u=o("I64"))).to_string(i)}),p.apply(this,arguments)}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.db,r=e.description,a=e.existingInstanceKey,l=e.jid,u=e.optimisticThreadKey,c=yield C(t.tables,l);if(c!=null)return{skippedOrFailedResult:babelHelpers.extends({},c,{jid:l})};var p=d(l,a,u,r),_=t.runInTransaction(function(e){return m(e,l,p)},"readwrite",void 0,void 0,i.id+":159"),f=yield u!=null?(s||(s=n("Promise"))).resolve(u):o("MAWThreadMappingQPL").measurePerformance("running_verify_thread_exists",p,function(){return _});return{instanceKey:p,passedOptimisticThreadKey:f}}),f.apply(this,arguments)}function g(e){var t=e.db,r=e.description,a=e.existingInstanceKey,l=e.jid,u=e.optimisticThreadKey;return t.runInTransaction((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield C(e,l);if(t!=null)return{skippedOrFailedResult:babelHelpers.extends({},t,{jid:l})};var i=d(l,a,u,r),c=yield u!=null?(s||(s=n("Promise"))).resolve(u):o("MAWThreadMappingQPL").measurePerformance("running_verify_thread_exists",i,function(){return m(e,l,i)});return{instanceKey:i,passedOptimisticThreadKey:c}});return function(t){return e.apply(this,arguments)}})(),"readwrite",void 0,void 0,i.id+":182").catch(function(){return{skippedOrFailedResult:{isCreated:!1,jid:l}}})}function h(e,t,n,r,o,a){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,a,i,l,c){var d=o("MAWJids").convertIntJidToOneToOneChatJid(t),m={db:e,description:i,existingInstanceKey:c,jid:d,optimisticThreadKey:a},p=yield r("gkx")("17734")?g(m):_(m);if(p.skippedOrFailedResult!=null)return p.skippedOrFailedResult;var f=p.instanceKey,h=p.passedOptimisticThreadKey,y=(u||(u=o("I64"))).to_string(t),C=function(a){l!=null&&r("QPLUserFlow").addPoint(r("qpl")._(25313175,"1551"),"verify-e2ee-metadata-thread-exists-end",{instanceKey:l});var t={contactFbid:y,description:i,instanceKey:f,s2sInstanceKey:l,threadKey:a},u=S(e,d,i,t);return(s||(s=n("Promise"))).all([u,r("WMIWABridgeApi").getDevices({ignoreDhash:!1,reason:"creating-1-1-thread: "+i,users:new Set().add(o("MAWJids").toUserJid(y))})]).then(function(e){var t=e[0].isCreated;return t})};return C(h).then(function(e){return{isCreated:e,jid:d}})}),y.apply(this,arguments)}function C(e,t){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield o("MAWThreadLoadingState").genLoadingStateFromJid(e,t);if(n.miState!==o("MAWThreadLoadingState").MiState.MISSING)return{isCreated:!1}}),b.apply(this,arguments)}function v(e,t,n){return o("MAWMiActMappingTableAPI").getMappingRowForChatJid(e,n).then(function(r){return r!=null&&o("MAWThreadLoadingState").markActThreadLoadingAsCompletedForJid(e,{jid:n,threadKey:(u||(u=o("I64"))).of_string(t)})})}function S(t,n,r,a){var l=a.instanceKey,s=babelHelpers.objectWithoutPropertiesLoose(a,e);return o("MAWThreadMappingQPL").measurePerformance("maw_create_thread",l,function(){return o("MAWBridgeSendAndReceive").sendAndReceive("backend","createOrUpdateThread",s)}).then(function(e){var a=e.created;return t.runInTransaction(function(e){return o("MAWHandleActThread").handleActThreadWhenOptimisticInMI(e,{description:r,instanceKey:l,jid:n,optimisticThreadKey:s.threadKey}).then(function(){return v(e,s.threadKey,n).then(function(){return{isCreated:a}})})},"readwrite",void 0,void 0,i.id+":337")})}function R(e,t){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield o("MAWMiActMappingTableAPI").getMappingRowForChatJid(e,t);return n==null}),L.apply(this,arguments)}l.call=h}),98);
__d("ResumableUploadServiceState.enum",[],(function(t,n,r,o,a,i){"use strict";var e=Object.freeze({CANCEL:"upload-cancel",FAIL:"upload-fail",FILE_TOO_LARGE:"upload-too-large",NOT_STARTED:"upload-not-started",PROGRESS:"upload-progress",START:"upload-start",SUCCESS:"upload-success",TRANSPORT_FAILURE:"upload-transport-fail"});i.default=e}),66);
__d("MWPComposerMediaUploadUtil",["FileMercuryUploadService","I64","LSGetAttachmentType","LSIntEnum","MessagingAttachmentType","Promise","ResumableUploadServiceState.enum","URI","asyncToGeneratorRuntime","cr:7187","emptyFunction","gkx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="messenger_file",m="messenger_audio",p="messenger_image",_="messenger_video",f="file_type",g="image_type",h="video_type",y="audio_type",C="FILE_ATTACHMENT",b="VOICE_MESSAGE",v="target_id";function S(e,t,a,i,l,s){if(a===void 0&&(a=r("emptyFunction")),!!n("cr:7187")){var S=(c||(c=r("URI"))).getRequestURI().getDomain(),R=/workplace.com/i.test(S)?"workplace.com":/messenger.com/i.test(S)?"messenger.com":"facebook.com";i.forEach(function(i,c){var S,L=i.attachmentType,E=i.file,k=d,I=f,T=C;switch(L){case(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").IMAGE):k=p,I=g;break;case(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").AUDIO):k=m,I=y,T=b;break;case(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").VIDEO):k=_,I=h;break;default:break}var D=n("cr:7187").create({consumer:k,customHttpHeaders:new Map([[v,s],[I,T]]),serviceDomain:R});D.addListener((S=r("ResumableUploadServiceState.enum")).START,function(){e&&e(l[c],E.size,E.type)}),D.addListener(S.SUCCESS,function(e){t(l[c],e.media_id)}),D.addListener(S.FAIL,function(e){a(l[c],{response:e})}),D.addListener(S.TRANSPORT_FAILURE,function(e){a(l[c],{response:e})}),D.resume(E)})}}function R(e,t,n,r,o,a,i,l,s,u,c,d,m){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a,i,l,c,d,m,p,_,f,g,h,y){if(a===void 0&&(a=r("emptyFunction")),l===void 0&&(l=r("emptyFunction")),c===void 0&&(c=!1),n("cr:7187")&&h!=null&&p!==!0){var C=[],b=[],v=[],R=[],L=yield(e||(e=n("Promise"))).all(d.map(function(e){return o("LSGetAttachmentType").LSGetAttachmentType(e)}));d.forEach(function(e,t){var n=L[t];(s||(s=o("I64"))).equal(n,(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").VIDEO))?(C.push({attachmentType:n,file:e}),b.push(m[t])):(v.push(e),R.push(m[t]))}),C.length>0&&S(t,i,l,C,b,h),v.length>0&&r("promiseDone")(o("FileMercuryUploadService").uploadByMercuryUploadService({chatSupportUserId:_,chatSupportUserNonce:g,files:v,isChatSupportUser:p,isVoiceClip:c,onUploadFailure:l,onUploadProgress:a,onUploadStart:t,onUploadSuccess:i,retryCount:r("gkx")("1132")?5:0,uploadIDs:R,uploadIdToQplFlow:y,voiceClipWaveformData:f}))}else r("promiseDone")(o("FileMercuryUploadService").uploadByMercuryUploadService({chatSupportUserId:_,chatSupportUserNonce:g,files:d,isChatSupportUser:p,isVoiceClip:c,onUploadFailure:l,onUploadProgress:a,onUploadStart:t,onUploadSuccess:i,retryCount:r("gkx")("1132")?5:0,uploadIDs:m,uploadIdToQplFlow:y,voiceClipWaveformData:f}))}),L.apply(this,arguments)}function E(e,t,n,a){var i;return{action_url:void 0,attachment_fbid:e,attachment_index:(s||(s=o("I64"))).zero,attachment_type:(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").AUDIO),cta1_title:void 0,cta2_title:void 0,cta3_title:void 0,description_text:void 0,filename:void 0,filesize:void 0,has_media:!0,has_xma:!1,image_url:void 0,mini_preview:void 0,offline_attachment_id:e,original_file_hash:void 0,playable_duration_ms:s.of_float(n*1e3),playable_url:URL.createObjectURL(t),playable_url_mime_type:t.type,preview_height:void 0,preview_url:void 0,preview_url_mime_type:void 0,preview_width:void 0,sampling_frequency_hz:a==null?void 0:a.sampling_freq,source_text:void 0,subtitle_text:void 0,title_text:void 0,waveform_data:a==null||(i=a.amplitudes)==null?void 0:i.join(","),xma_layout_type:void 0,xmas_template_type:void 0}}function k(e,t,n){var a=e.map(function(e){return{action_url:void 0,attachment_fbid:e.offlineAttachmentId,attachment_index:(s||(s=o("I64"))).zero,attachment_type:e.attachmentType,cta1_title:void 0,cta2_title:void 0,cta3_title:void 0,description_text:void 0,filename:e.filename,filesize:void 0,has_media:!0,has_xma:!1,image_url:void 0,mini_preview:void 0,offline_attachment_id:e.offlineAttachmentId,original_file_hash:void 0,playable_duration_ms:void 0,playable_url:e.previewUrl,playable_url_mime_type:e.mimeType,preview_height:e.previewHeight,preview_url:e.previewUrl,preview_url_mime_type:void 0,preview_width:e.previewWidth,source_text:void 0,subtitle_text:void 0,title_text:void 0,xma_layout_type:void 0,xmas_template_type:void 0}}),i=[],l=[];return a.forEach(function(e){((s||(s=o("I64"))).equal(e.attachment_type,(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").IMAGE))||r("gkx")("4280")&&(s||(s=o("I64"))).equal(e.attachment_type,(u||(u=o("LSIntEnum"))).ofNumber(r("MessagingAttachmentType").VIDEO)))&&!t?(l.push(e),n===!0&&l.length===30&&(i.unshift([].concat(l)),l.length=0)):i.push([e])}),l.length>0&&(n===!0?i.push(l):i.unshift(l)),i.map(function(e){return e.map(function(e,t){return babelHelpers.extends({},e,{attachment_index:(s||(s=o("I64"))).of_int32(t)})})})}l.startUpload=R,l.getAudioAttachment=E,l.createPartitionedAttachments=k}),98);
__d("MWPOpenComposerUtils",["I64","LSRemoveMediaSendJobsStoredProcedure","LSResumeMediaSendJobStoredProcedure","MWConsole","Promise","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){return e.media_staging.get(t).then(function(r){return r!=null?e.media_staging.delete(t):(s||(s=n("Promise"))).resolve()})}function c(e,t,n){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=yield e.media_staging.get(t);r!=null&&(yield e.media_staging.put(n(r)))}),d.apply(this,arguments)}function m(e,t,r,o,a){return e.attachments.get(t,r,o).then(function(i){return i!=null?e.attachments.upsert([t,r,o],a(i)):(s||(s=n("Promise"))).resolve()})}function p(t,a,i){return r("LSResumeMediaSendJobStoredProcedure")(t,{dataTraceId:i!=null?i:void 0,jobId:a,pluginType:(e||(e=o("I64"))).zero}).then(function(e){var o=e[0],i=e[1],l=e[2];return o?r("LSRemoveMediaSendJobsStoredProcedure")(t,{offlineThreadingId:a}):(s||(s=n("Promise"))).resolve()})}l.deleteMediaStaging=u,l.updateMediaStaging=c,l.updateAttachment=m,l.resumeSendJob=p}),98);
__d("MessagePowerUp",[],(function(t,n,r,o,a,i){var e=Object.freeze({AVATAR_LOVE:1e3,AVATAR_ANGER:1001,AVATAR_LAUGH:1002,AVATAR_CRY:1003,NONE:0,LOVE:1,GIFT_WRAP:2,CELEBRATION:3,FIRE:4,HALLOWEEN:5,NOM_NOM_DASH:6,NEW_YEARS:7,VALENTINES_DAY:8,ANTI_VALENTINES:9});i.default=e}),66);
__d("coerceMessagingThreadTypeToLSThreadType",["LSIntEnum"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return(e||(e=o("LSIntEnum"))).unwrapIntEnum(t)}l.default=s}),98);
__d("getIsMessageTimeBelowEditThreshold",["I64"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(e||(e=o("I64"))).of_int32(900);function u(t,n){var r=(e||(e=o("I64"))).div(t,e.of_int32(1e3)),a=e.div(n,e.of_int32(1e3)),i=e.sub(r,a);return e.lt(i,s)}l.MAX_EDIT_TIME_PERIOD_IN_SECONDS=s,l.getIsMessageTimeBelowEditThreshold=u}),98);
__d("useLSMessagingInitiatingSource",["LSIntEnum","LSMessagingInitiatingSource","MWLSThreadDisplayContext"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=o("MWLSThreadDisplayContext").useMWLSThreadDisplayContext();if(t!=null)return t==="Inbox"?(e||(e=o("LSIntEnum"))).ofNumber(r("LSMessagingInitiatingSource").FACEBOOK_INBOX):t==="FullscreenChat"?(e||(e=o("LSIntEnum"))).ofNumber(r("LSMessagingInitiatingSource").FACEBOOK_FULLSCREEN):t==="ChatTab"?(e||(e=o("LSIntEnum"))).ofNumber(r("LSMessagingInitiatingSource").FACEBOOK_CHAT):(e||(e=o("LSIntEnum"))).ofNumber(r("LSMessagingInitiatingSource").ROOMS_SIDE_CHAT)}l.default=s}),98);